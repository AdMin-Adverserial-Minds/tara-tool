<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TARA Framework - Threat Analysis & Risk Assessment for LLM Applications</title>
    <style>
        :root {
            --critical: #d32f2f;
            --very-high: #f57c00;
            --high: #fbc02d;
            --medium: #ffeb3b;
            --low: #8bc34a;
            --very-low: #4caf50;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-input: #0f3460;
            --text-primary: #eaeaea;
            --text-secondary: #a0a0a0;
            --accent: #e94560;
        }

        /* Light mode variables */
        [data-theme="light"] {
            --bg-dark: #f5f5f5;
            --bg-card: #ffffff;
            --bg-input: #e8e8e8;
            --text-primary: #1a1a2e;
            --text-secondary: #555555;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px 10px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 30px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid var(--accent);
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent), #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .citation {
            background: var(--bg-card);
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
            border-left: 4px solid var(--accent);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .tab-btn:hover, .tab-btn.active {
            background: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .card h2 {
            color: var(--accent);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .card h3 {
            color: var(--text-primary);
            margin: 20px 0 15px;
            font-size: 1.2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid #333;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--bg-input);
            border-radius: 8px;
            margin: 10px 0;
        }

        .score-value {
            font-size: 2rem;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }

        .score-label {
            color: var(--text-secondary);
        }

        .risk-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.75rem;
            white-space: nowrap;
            display: inline-block;
        }

        .risk-critical { background: var(--critical); color: white; }
        .risk-very-high { background: var(--very-high); color: white; }
        .risk-high { background: var(--high); color: #333; }
        .risk-medium { background: var(--medium); color: #333; }
        .risk-low { background: var(--low); color: white; }
        .risk-very-low { background: var(--very-low); color: white; }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #ff6b6b;
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #1a4a7a;
        }

        .btn-import {
            background: #0d7377;
            color: white;
        }

        .btn-import:hover {
            background: #14a3a8;
        }

        .btn-danger {
            background: var(--critical);
            color: white;
        }

        /* Risk Matrix */
        .risk-matrix {
            display: grid;
            grid-template-columns: auto repeat(5, 1fr);
            gap: 2px;
            margin: 20px 0;
            font-size: 0.85rem;
        }

        .matrix-cell {
            padding: 15px 10px;
            text-align: center;
            border-radius: 4px;
        }

        .matrix-header {
            background: var(--bg-input);
            font-weight: bold;
        }

        .matrix-label {
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Threats Table */
        .threats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .threats-table th,
        .threats-table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #333;
            vertical-align: middle;
        }

        .threats-table th {
            background: var(--bg-input);
            color: var(--accent);
            white-space: nowrap;
        }

        .threats-table td {
            white-space: nowrap;
        }

        .threats-table tr:hover {
            background: rgba(233, 69, 96, 0.1);
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .info-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            margin-left: 5px;
        }

        /* Stats Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-input);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .stat-label {
            color: var(--text-secondary);
        }

        /* Charts area */
        .chart-container {
            height: 300px;
            margin: 20px 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                width: 100%;
            }
        }

        .stride-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .stride-item {
            padding: 10px;
            background: var(--bg-input);
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .stride-item:hover {
            border-color: var(--accent);
        }

        .stride-item.selected {
            border-color: var(--accent);
            background: rgba(233, 69, 96, 0.2);
        }

        .stride-item .letter {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
        }

        .stride-item .name {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .section-divider {
            border: none;
            border-top: 1px solid #333;
            margin: 30px 0;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .threat-actions {
            display: flex;
            gap: 5px;
        }

        .threat-actions button {
            padding: 5px 10px;
            font-size: 0.85rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 16px 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-color: #4ade80;
        }

        .toast.error {
            border-color: #f87171;
        }

        .toast-icon {
            font-size: 1.4rem;
        }

        .toast-message {
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        /* Confirmation modal */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .confirm-modal.active {
            display: flex;
        }

        .confirm-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .confirm-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .confirm-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .confirm-message {
            color: var(--text-secondary);
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 0.95rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .confirm-btn.cancel {
            background: var(--bg-dark);
            color: var(--text-primary);
        }

        .confirm-btn.cancel:hover {
            background: #3a3a3a;
        }

        .confirm-btn.confirm {
            background: var(--accent);
            color: white;
        }

        .confirm-btn.confirm:hover {
            background: #3b82f6;
        }

        .confirm-btn.danger {
            background: #dc2626;
        }

        .confirm-btn.danger:hover {
            background: #b91c1c;
        }

        /* Admin Panel Styles */
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .admin-section {
            background: var(--bg-dark);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #333;
        }

        .admin-section.full-width {
            grid-column: span 2;
        }

        .admin-section .section-header {
            margin-bottom: 10px;
        }

        .admin-section .section-header h3 {
            font-size: 1.1rem;
        }

        .admin-desc {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 15px;
        }

        .admin-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .admin-input {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid #444;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .admin-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .admin-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
            min-height: 30px;
        }

        .admin-tag {
            background: var(--bg-card);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #444;
        }

        .admin-tag button {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            line-height: 1;
        }

        .admin-tag button:hover {
            color: #ff6b6b;
        }

        .admin-defaults {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
        }

        .admin-category-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .admin-category-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-card);
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #444;
        }

        .admin-category-item .category-name {
            flex: 1;
            font-size: 0.9rem;
        }

        .admin-category-item .category-badge {
            background: var(--accent);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .admin-category-item .category-badge.default {
            background: #666;
        }

        .admin-category-item button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1rem;
            padding: 4px;
        }

        .admin-category-item button:hover {
            color: #ff6b6b;
        }

        .admin-category-item button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .risk-levels-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .risk-level-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-card);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .risk-level-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid #555;
        }

        .risk-level-name {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .admin-calc-setting {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-calc-setting label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .admin-calc-setting select {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid #444;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .admin-default-note {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(99, 102, 241, 0.1);
            border-left: 3px solid var(--accent);
            border-radius: 0 6px 6px 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .admin-levels-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .admin-level-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-card);
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #444;
        }

        .admin-level-item .level-value {
            width: 30px;
            height: 30px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .admin-level-item input {
            flex: 1;
            padding: 6px 10px;
            background: var(--bg-dark);
            border: 1px solid #444;
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .admin-level-item input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .admin-matrix-container {
            overflow-x: auto;
        }

        .admin-matrix {
            display: grid;
            grid-template-columns: 120px repeat(5, 1fr);
            gap: 4px;
            min-width: 600px;
        }

        .admin-matrix-cell {
            padding: 12px 8px;
            text-align: center;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .admin-matrix-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .admin-matrix-cell.header {
            background: var(--bg-card);
            cursor: default;
            font-weight: 600;
        }

        .admin-matrix-cell.header:hover {
            transform: none;
            box-shadow: none;
        }

        .admin-matrix-cell.label {
            background: var(--bg-card);
            cursor: default;
            text-align: right;
            padding-right: 15px;
        }

        .admin-matrix-cell.label:hover {
            transform: none;
            box-shadow: none;
        }

        .risk-level-item input[type="text"] {
            width: 100px;
            padding: 4px 8px;
            background: var(--bg-dark);
            border: 1px solid #444;
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        @media (max-width: 900px) {
            .admin-grid {
                grid-template-columns: 1fr;
            }
            .admin-section.full-width {
                grid-column: span 1;
            }
            .risk-levels-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .collapsible {
            cursor: pointer;
            padding: 15px;
            background: var(--bg-input);
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible:after {
            content: '+';
            font-size: 1.2rem;
        }

        .collapsible.active:after {
            content: '-';
        }

        .collapsible-content {
            display: none;
            padding: 15px;
            background: rgba(15, 52, 96, 0.5);
            border-radius: 0 0 6px 6px;
            margin-top: -10px;
            margin-bottom: 10px;
        }

        .collapsible-content.show {
            display: block;
        }

        /* Expandable threat details */
        .threat-row {
            cursor: pointer;
        }

        .threat-row:hover {
            background: rgba(233, 69, 96, 0.1);
        }

        .threat-details {
            display: none;
            background: rgba(15, 52, 96, 0.5);
            padding: 20px;
            border-left: 4px solid var(--accent);
        }

        .threat-details.show {
            display: table-row;
        }

        .threat-details td {
            padding: 20px !important;
            white-space: normal !important;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .details-section {
            background: var(--bg-input);
            padding: 18px;
            border-radius: 8px;
            min-width: 0;
            overflow: hidden;
        }

        .details-section p {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.5;
        }

        .details-section h4 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 0.95rem;
            word-wrap: break-word;
        }

        .details-section p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 8px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            hyphens: auto;
        }

        .details-section .score-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #333;
            gap: 10px;
            flex-wrap: wrap;
        }

        .details-section .score-row:last-child {
            border-bottom: none;
        }

        .details-section .score-row span:first-child {
            flex-shrink: 0;
            white-space: nowrap;
        }

        .details-section .score-row span:last-child {
            text-align: right;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .expand-icon {
            display: inline-block;
            width: 20px;
            transition: transform 0.3s;
        }

        .expand-icon.rotated {
            transform: rotate(90deg);
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--bg-input);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--accent);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        /* Expanded table styles */
        .expanded-table {
            font-size: 0.95rem;
            min-width: 1300px;
            table-layout: fixed;
        }

        .expanded-table th {
            font-size: 0.8rem;
            padding: 12px 6px;
            white-space: nowrap;
        }

        .expanded-table td {
            padding: 12px 6px;
            vertical-align: middle;
            white-space: nowrap;
            font-size: 0.95rem;
        }

        .expanded-table .risk-badge {
            padding: 4px 6px;
            font-size: 0.65rem;
            white-space: nowrap;
        }

        /* Impact/Likelihood cells centered */
        .expanded-table td.impact-cell,
        .expanded-table td.score-cell {
            text-align: center;
            cursor: help;
        }

        .expanded-table td.impact-cell:hover,
        .expanded-table td.score-cell:hover,
        .expanded-table td.likelihood-cell:hover {
            opacity: 0.8;
        }

        /* Likelihood cell coloring (higher = easier to exploit) */
        .likelihood-cell {
            text-align: center;
            font-weight: bold;
            border-radius: 4px;
            font-size: 1rem;
            cursor: help;
        }

        .likelihood-cell.likelihood-0 {
            background: rgba(76, 175, 80, 0.3);
            color: #6fcf6f;
        }

        .likelihood-cell.likelihood-1 {
            background: rgba(139, 195, 74, 0.3);
            color: #a4d65e;
        }

        .likelihood-cell.likelihood-2 {
            background: rgba(255, 235, 59, 0.3);
            color: #ffe135;
        }

        .likelihood-cell.likelihood-3 {
            background: rgba(245, 124, 0, 0.3);
            color: #ffa040;
        }

        /* Numeric cells - larger and bolder */
        .expanded-table .impact-cell,
        .expanded-table td:nth-child(n+6):nth-child(-n+10),
        .expanded-table td:nth-child(n+11):nth-child(-n+17) {
            font-size: 1rem;
            font-weight: 600;
        }

        /* Column widths for expanded table */
        .expanded-table .col-id { width: 35px; }
        .expanded-table .col-name { width: 120px; }
        .expanded-table .col-class { width: 80px; }
        .expanded-table .col-target { width: 65px; }
        .expanded-table .col-stride { width: 55px; }
        .expanded-table .col-impact { width: 38px; text-align: center; }
        .expanded-table .col-likelihood { width: 38px; text-align: center; }
        .expanded-table .col-risk { width: 70px; }
        .expanded-table .col-risk-main { width: 75px; }
        .expanded-table .col-risk-resid { width: 70px; }
        .expanded-table .col-actions { width: 75px; }

        /* Impact cell coloring */
        .impact-cell {
            text-align: center;
            font-weight: bold;
            border-radius: 4px;
            font-size: 1.1rem !important;
        }

        .impact-cell.impact-0 {
            background: rgba(76, 175, 80, 0.3);
            color: #6fcf6f;
        }

        .impact-cell.impact-1 {
            background: rgba(139, 195, 74, 0.3);
            color: #a4d65e;
        }

        .impact-cell.impact-2 {
            background: rgba(255, 235, 59, 0.3);
            color: #ffe135;
        }

        .impact-cell.impact-3 {
            background: rgba(245, 124, 0, 0.3);
            color: #ffa040;
        }

        .impact-cell.impact-4 {
            background: rgba(211, 47, 47, 0.3);
            color: #ff6b6b;
        }

        /* Scrollable table container */
        .expanded-table-container {
            overflow-x: auto;
            margin: 0 -10px;
            padding: 0 10px;
        }

        /* Tooltip headers in expanded table */
        .tooltip-header {
            cursor: help;
            position: relative;
        }

        .tooltip-header:hover {
            color: var(--accent);
        }

        .impact-header {
            background: rgba(255, 235, 59, 0.1) !important;
        }

        .likelihood-header {
            background: rgba(33, 150, 243, 0.1) !important;
        }

        .risk-header {
            background: rgba(233, 69, 96, 0.1) !important;
        }

        /* Category header row */
        .category-row {
            background: var(--bg-dark) !important;
        }

        .category-header {
            text-align: center !important;
            font-size: 0.85rem !important;
            font-weight: bold !important;
            padding: 10px 8px !important;
            border-bottom: 2px solid #444 !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-info {
            background: rgba(100, 100, 100, 0.2) !important;
            color: var(--text-secondary);
            border-right: 3px solid #555 !important;
        }

        .category-impact {
            background: rgba(255, 235, 59, 0.2) !important;
            color: #ffe135;
            border-right: 3px solid #555 !important;
        }

        .category-likelihood {
            background: rgba(33, 150, 243, 0.2) !important;
            color: #64b5f6;
            border-right: 3px solid #555 !important;
        }

        .category-risk {
            background: rgba(233, 69, 96, 0.2) !important;
            color: var(--accent);
            border-right: 3px solid #555 !important;
        }

        /* Column borders to separate categories */
        .expanded-table td.border-right,
        .expanded-table th.border-right {
            border-right: 3px solid #555 !important;
        }

        /* Theme toggle button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 2px solid var(--accent);
            color: var(--text-primary);
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.2rem;
            z-index: 1000;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle:hover {
            background: var(--accent);
            color: white;
        }

        /* Search and filter bar */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-input);
            border-radius: 10px;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            background: var(--bg-dark);
            border: 1px solid #444;
            border-radius: 25px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .filter-select {
            padding: 8px 12px;
            background: var(--bg-dark);
            border: 1px solid #444;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Sortable headers */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .sortable:hover {
            background: rgba(233, 69, 96, 0.2);
        }

        .sort-icon {
            margin-left: 5px;
            opacity: 0.3;
            font-size: 0.8em;
        }

        .sortable.sort-asc .sort-icon,
        .sortable.sort-desc .sort-icon {
            opacity: 1;
        }

        .sortable.sort-asc .sort-icon::after {
            content: '‚ñ≤';
        }

        .sortable.sort-desc .sort-icon::after {
            content: '‚ñº';
        }

        .sortable:not(.sort-asc):not(.sort-desc) .sort-icon::after {
            content: '‚áÖ';
        }

        /* Dashboard charts */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chart-container {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 20px;
        }

        .chart-container h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            height: 200px;
            padding: 10px 0;
        }

        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .bar {
            width: 100%;
            max-width: 60px;
            border-radius: 5px 5px 0 0;
            transition: height 0.3s;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 5px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .bar-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .pie-chart {
            display: flex;
            align-items: center;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .pie-visual {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            position: relative;
        }

        .pie-legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        /* Risk matrix interactive */
        .matrix-cell.has-threats {
            cursor: pointer;
            position: relative;
        }

        .matrix-cell.has-threats::after {
            content: attr(data-count);
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--bg-dark);
            color: var(--text-primary);
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        .matrix-cell.has-threats:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        /* Export/Import Grid */
        .export-import-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .export-section {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #333;
        }

        .export-section.danger-zone {
            border-color: var(--critical);
            background: rgba(211, 47, 47, 0.1);
        }

        .export-section .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .export-section .section-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .export-section .section-icon {
            font-size: 1.5rem;
        }

        .export-section .action-buttons {
            display: flex;
            gap: 10px;
        }

        .danger-zone .section-header h3 {
            color: var(--critical);
        }

        /* Confirmation modal */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .confirm-modal.active {
            display: flex;
        }

        .confirm-modal-content {
            background: var(--bg-card);
            border: 2px solid var(--critical);
            border-radius: 12px;
            padding: 30px;
            max-width: 450px;
            text-align: center;
        }

        .confirm-modal-content h3 {
            color: var(--critical);
            margin-bottom: 15px;
        }

        .confirm-modal-content p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .confirm-modal-content .confirm-input {
            width: 100%;
            margin-bottom: 20px;
        }

        .confirm-modal-content .confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span class="toast-icon" id="toast-icon">‚úì</span>
        <span class="toast-message" id="toast-message"></span>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirm-modal">
        <div class="confirm-content">
            <div class="confirm-icon" id="confirm-icon">‚ùì</div>
            <div class="confirm-title" id="confirm-title">Confirm</div>
            <div class="confirm-message" id="confirm-message"></div>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" onclick="closeConfirmModal(false)">Cancel</button>
                <button class="confirm-btn confirm" id="confirm-btn" onclick="closeConfirmModal(true)">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
        üåô
    </button>

    <div class="container">
        <header>
            <h1>TARA Framework</h1>
            <p>Threat Analysis & Risk Assessment for LLM-Powered Applications</p>
            <div class="citation">
                <strong>Based on:</strong> "Invitation Is All You Need! Promptware Attacks Against LLM-Powered Assistants in Production Are Practical and Dangerous"
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab-btn" onclick="showTab('add-threat')">Add Threat</button>
            <button class="tab-btn" onclick="showTab('threats-list')">Threats List</button>
            <button class="tab-btn" onclick="showTab('risk-matrix')">Risk Matrix</button>
            <button class="tab-btn" onclick="showTab('methodology')">Methodology</button>
            <button class="tab-btn" onclick="showTab('export')">Export / Import</button>
            <button class="tab-btn" onclick="showTab('admin')">‚öôÔ∏è Admin</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-threats">0</div>
                    <div class="stat-label">Total Threats</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value risk-critical" id="critical-count">0</div>
                    <div class="stat-label">Critical Risks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value risk-high" id="high-count">0</div>
                    <div class="stat-label">High Risks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value risk-medium" id="medium-count">0</div>
                    <div class="stat-label">Medium Risks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value risk-low" id="low-count">0</div>
                    <div class="stat-label">Low Risks</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <h2>üìä Risk Distribution</h2>
                    <div id="risk-chart" style="height: 280px; display: flex; align-items: flex-end; gap: 20px; padding: 20px;">
                        <div style="text-align: center; color: var(--text-secondary);">Add threats to see risk distribution</div>
                    </div>
                </div>

                <div class="card">
                    <h2>üéØ STRIDE Categories</h2>
                    <div id="stride-chart" style="height: 280px; display: flex; align-items: flex-end; gap: 15px; padding: 20px;">
                        <div style="text-align: center; color: var(--text-secondary);">Add threats to see STRIDE distribution</div>
                    </div>
                </div>

                <div class="card">
                    <h2>üè∑Ô∏è Threat Classes</h2>
                    <div id="class-chart" style="height: 280px; display: flex; align-items: flex-end; gap: 15px; padding: 20px;">
                        <div style="text-align: center; color: var(--text-secondary);">Add threats to see threat class distribution</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìã Recent Threats</h2>
                <div id="recent-threats">
                    <p style="color: var(--text-secondary);">No threats added yet. Go to "Add Threat" to begin your assessment.</p>
                </div>
            </div>
        </div>

        <!-- Add Threat Tab -->
        <div id="add-threat" class="tab-content">
            <div class="card">
                <h2>Add New Threat</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Threat ID</label>
                        <input type="text" id="threat-id" placeholder="e.g., T1, T2, T3...">
                    </div>
                    <div class="form-group">
                        <label>Threat Name</label>
                        <input type="text" id="threat-name" placeholder="e.g., Data Exfiltration via Browser">
                    </div>
                </div>

                <div class="form-group">
                    <label>Threat Description</label>
                    <textarea id="threat-description" placeholder="Describe the threat in detail..."></textarea>
                </div>

                <div class="form-group">
                    <label>Attack Scenario / Steps</label>
                    <textarea id="attack-scenario" placeholder="Describe how the attack works step by step..."></textarea>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Threat Class</label>
                        <select id="threat-class">
                            <option value="">Select a threat class...</option>
                            <option value="Short-term Context Poisoning">Short-term Context Poisoning</option>
                            <option value="Long-term Memory Poisoning">Long-term Memory Poisoning</option>
                            <option value="Tool Misuse">Tool Misuse</option>
                            <option value="Automatic Agent Invocation">Automatic Agent Invocation</option>
                            <option value="Automatic App Invocation">Automatic App Invocation</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Target Application</label>
                        <input type="text" id="threat-target" placeholder="e.g., Gemini for Mobile, Google Assistant, Gemini for Web...">
                    </div>
                </div>

                <h3>STRIDE Category 
                    <span class="tooltip">
                        <span class="info-icon">?</span>
                        <span class="tooltip-text">
                            <strong>STRIDE+O</strong> is a threat modeling framework:<br><br>
                            <strong>S</strong>poofing - Impersonating something or someone<br>
                            <strong>T</strong>ampering - Modifying data or code<br>
                            <strong>R</strong>epudiation - Denying performed actions<br>
                            <strong>I</strong>nformation Disclosure - Exposing information<br>
                            <strong>D</strong>enial of Service - Disrupting availability<br>
                            <strong>E</strong>levation of Privilege - Gaining unauthorized access<br>
                            <strong>O</strong>ther - Threats not fitting other categories
                        </span>
                    </span>
                </h3>
                <div class="stride-grid" id="stride-selector">
                    <div class="stride-item" data-stride="S" onclick="toggleStride(this)">
                        <div class="letter">S</div>
                        <div class="name">Spoofing</div>
                    </div>
                    <div class="stride-item" data-stride="T" onclick="toggleStride(this)">
                        <div class="letter">T</div>
                        <div class="name">Tampering</div>
                    </div>
                    <div class="stride-item" data-stride="R" onclick="toggleStride(this)">
                        <div class="letter">R</div>
                        <div class="name">Repudiation</div>
                    </div>
                    <div class="stride-item" data-stride="I" onclick="toggleStride(this)">
                        <div class="letter">I</div>
                        <div class="name">Info Disclosure</div>
                    </div>
                    <div class="stride-item" data-stride="D" onclick="toggleStride(this)">
                        <div class="letter">D</div>
                        <div class="name">Denial of Service</div>
                    </div>
                    <div class="stride-item" data-stride="E" onclick="toggleStride(this)">
                        <div class="letter">E</div>
                        <div class="name">Elevation of Privilege</div>
                    </div>
                    <div class="stride-item" data-stride="O" onclick="toggleStride(this)">
                        <div class="letter">O</div>
                        <div class="name">Other</div>
                    </div>
                </div>

                <hr class="section-divider">

                <h3>Impact Assessment 
                    <span class="tooltip">
                        <span class="info-icon">?</span>
                        <span class="tooltip-text" id="impact-tooltip-text">
                            Impact is determined by the configured calculation method.
                        </span>
                    </span>
                </h3>
                
                <div class="form-grid" id="impact-categories-container">
                    <!-- Dynamically generated impact category dropdowns -->
                </div>

                <div class="score-display">
                    <div>
                        <div class="score-value" id="impact-score">0</div>
                        <div class="score-label">Impact Score</div>
                    </div>
                    <div>
                        <span class="risk-badge" id="impact-category">NEGLIGIBLE</span>
                    </div>
                </div>

                <hr class="section-divider">

                <h3>Likelihood / Practicality Assessment
                    <span class="tooltip">
                        <span class="info-icon">?</span>
                        <span class="tooltip-text" id="likelihood-tooltip-text">
                            Likelihood is calculated using the configured calculation method.
                            Higher scores = more likely/practical attack.
                        </span>
                    </span>
                </h3>

                <div class="form-grid" id="likelihood-factors-container">
                    <!-- Dynamically generated likelihood factor dropdowns -->
                </div>

                <div class="score-display">
                    <div>
                        <div class="score-value" id="likelihood-score">3.00</div>
                        <div class="score-label">Likelihood Score</div>
                    </div>
                    <div>
                        <span class="risk-badge" id="likelihood-category">VERY LIKELY</span>
                    </div>
                </div>

                <hr class="section-divider">

                <h3>Calculated Risk</h3>
                <div class="score-display" style="justify-content: center; padding: 30px;">
                    <div style="text-align: center;">
                        <div class="score-value" style="font-size: 3rem;" id="final-risk-score">LOW</div>
                        <div class="score-label">Global Risk Score</div>
                        <span class="risk-badge risk-low" id="final-risk-badge" style="margin-top: 10px; display: inline-block;">LOW</span>
                    </div>
                </div>

                <hr class="section-divider">

                <h3>Mitigations</h3>
                <div class="form-group">
                    <label>Suggested Mitigations</label>
                    <textarea id="mitigations" placeholder="Describe mitigations that could reduce this risk..."></textarea>
                </div>

                <div class="collapsible" onclick="toggleCollapsible(this)">
                    <span>Calculate Residual Risk (After Mitigations)</span>
                </div>
                <div class="collapsible-content">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Re-assess the likelihood factors assuming mitigations are deployed:
                    </p>
                    <div class="form-grid" id="residual-factors-container">
                        <!-- Dynamically generated residual likelihood factor dropdowns -->
                    </div>
                    <div class="score-display">
                        <div>
                            <div class="score-value" id="residual-likelihood-score">0.00</div>
                            <div class="score-label">Residual Likelihood</div>
                        </div>
                        <div>
                            <span class="risk-badge" id="residual-risk-badge">VERY UNLIKELY</span>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="saveThreat()">Save Threat</button>
                    <button class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                </div>
            </div>
        </div>

        <!-- Threats List Tab -->
        <div id="threats-list" class="tab-content">
            <div class="card">
                <h2>All Threats</h2>
                
                <!-- Search and Filter Toolbar -->
                <div class="toolbar">
                    <input type="text" class="search-box" id="threat-search" placeholder="üîç Search threats by name, ID, description..." oninput="filterThreats()">
                    
                    <div class="filter-group">
                        <label>Risk:</label>
                        <select class="filter-select" id="filter-risk" onchange="filterThreats()">
                            <option value="">All</option>
                            <option value="CRITICAL">Critical</option>
                            <option value="VERY HIGH">Very High</option>
                            <option value="HIGH">High</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="LOW">Low</option>
                            <option value="VERY LOW">Very Low</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>STRIDE:</label>
                        <select class="filter-select" id="filter-stride" onchange="filterThreats()">
                            <option value="">All</option>
                            <option value="S">Spoofing</option>
                            <option value="T">Tampering</option>
                            <option value="R">Repudiation</option>
                            <option value="I">Info Disclosure</option>
                            <option value="D">Denial of Service</option>
                            <option value="E">Elevation of Privilege</option>
                            <option value="O">Other</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Target:</label>
                        <select class="filter-select" id="filter-target" onchange="filterThreats()">
                            <option value="">All</option>
                        </select>
                    </div>
                </div>
                
                <div class="toggle-container">
                    <span style="color: var(--text-secondary);">Compact (click rows to expand)</span>
                    <div class="toggle-switch" id="expand-toggle" onclick="toggleExpandAll()"></div>
                    <span style="color: var(--text-secondary);">Full Table (all columns)</span>
                </div>
                <div id="threats-container">
                    <p style="color: var(--text-secondary);">No threats added yet.</p>
                </div>
            </div>
        </div>

        <!-- Risk Matrix Tab -->
        <div id="risk-matrix" class="tab-content">
            <div class="card">
                <h2>üéØ Interactive Risk Matrix</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Risk = Impact √ó Likelihood. Click on any cell to see which threats fall into that risk category.
                </p>
                
                <div class="risk-matrix" id="risk-matrix-grid">
                    <!-- Will be dynamically generated -->
                </div>
                
                <div id="matrix-tooltip" style="margin-top: 20px; padding: 15px; background: var(--bg-input); border-radius: 8px; display: none;">
                    <h4 style="margin-bottom: 10px;">Threats in this category:</h4>
                    <div id="matrix-tooltip-content"></div>
                </div>

                <h3 style="margin-top: 30px;">üìã All Threats Summary</h3>
                <div id="threats-on-matrix" style="margin-top: 15px;">
                    <p style="color: var(--text-secondary);">Add threats to see them plotted on the risk matrix.</p>
                </div>
            </div>
        </div>

        <!-- Methodology Tab -->
        <div id="methodology" class="tab-content">
            <div class="card">
                <h2>TARA Methodology</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    This framework is based on the Threat Analysis and Risk Assessment methodology proposed in the paper 
                    "Invitation Is All You Need!" for evaluating risks to end users of LLM-powered applications.
                </p>

                <h3>Steps of Risk Assessment</h3>
                <table class="threats-table">
                    <thead>
                        <tr>
                            <th>Step</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>1. Asset Identification</strong></td>
                            <td>Cataloging all relevant user assets required to be secured (data, devices, applications, privacy)</td>
                        </tr>
                        <tr>
                            <td><strong>2. Adversary Identification</strong></td>
                            <td>Profiling the adversary and describing the threat model</td>
                        </tr>
                        <tr>
                            <td><strong>3. Threat Modeling</strong></td>
                            <td>Predicting the threats and attack vectors (using STRIDE)</td>
                        </tr>
                        <tr>
                            <td><strong>4. Likelihood & Impact</strong></td>
                            <td>Calculating threat practicality and impact scores</td>
                        </tr>
                        <tr>
                            <td><strong>5. Risk Assessment</strong></td>
                            <td>Creating a risk matrix from impact √ó likelihood</td>
                        </tr>
                        <tr>
                            <td><strong>6. Risk Treatment Plan</strong></td>
                            <td>Creating a mitigation plan (reduce, transfer, or accept)</td>
                        </tr>
                        <tr>
                            <td><strong>7. Residual Risk</strong></td>
                            <td>Reassessing threats given deployed mitigations</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Impact Score Calculation</h3>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                    Impact is determined by the <strong>highest score</strong> received in any of four factors:
                </p>
                <table class="threats-table">
                    <thead>
                        <tr>
                            <th>Score</th>
                            <th>Safety</th>
                            <th>Privacy</th>
                            <th>Financial</th>
                            <th>Operational</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>0 - Negligible</strong></td>
                            <td>No impact</td>
                            <td>No privacy outcome</td>
                            <td>No loss</td>
                            <td>No effect</td>
                        </tr>
                        <tr>
                            <td><strong>1 - Minor</strong></td>
                            <td>Mental health minor affected</td>
                            <td>Non-sensitive data exposed</td>
                            <td>Loss < $100</td>
                            <td>Easy to invert</td>
                        </tr>
                        <tr>
                            <td><strong>2 - Moderate</strong></td>
                            <td>Mental health significantly affected</td>
                            <td>User geolocated</td>
                            <td>Loss < $1K</td>
                            <td>Some effort to invert</td>
                        </tr>
                        <tr>
                            <td><strong>3 - Severe</strong></td>
                            <td>Physical environment affected</td>
                            <td>Important info exfiltrated</td>
                            <td>Loss < $10K</td>
                            <td>Significant effort</td>
                        </tr>
                        <tr>
                            <td><strong>4 - Critical</strong></td>
                            <td>Life-threatening</td>
                            <td>Sensitive data/video streaming</td>
                            <td>Loss > $10K</td>
                            <td>Loss of capability</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Likelihood Score Calculation</h3>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                    Likelihood is calculated as the <strong>average</strong> of six factors (0-3 scale each):
                </p>
                <table class="threats-table">
                    <thead>
                        <tr>
                            <th>Factor</th>
                            <th>3 (Easy)</th>
                            <th>2</th>
                            <th>1</th>
                            <th>0 (Hard)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Equipment</strong></td>
                            <td>Standard (laptop)</td>
                            <td>Specialized (GPU)</td>
                            <td>Multiple specialized</td>
                            <td>Restricted</td>
                        </tr>
                        <tr>
                            <td><strong>Expertise</strong></td>
                            <td>Layman</td>
                            <td>Proficient (B.Sc)</td>
                            <td>Expert (Ph.D)</td>
                            <td>Multiple experts</td>
                        </tr>
                        <tr>
                            <td><strong>Window of Opportunity</strong></td>
                            <td>Unlimited</td>
                            <td>Frequent</td>
                            <td>Rare (monthly)</td>
                            <td>Very rare (yearly)</td>
                        </tr>
                        <tr>
                            <td><strong>Knowledge</strong></td>
                            <td>Public</td>
                            <td>Email required</td>
                            <td>Password required</td>
                            <td>Implementation required</td>
                        </tr>
                        <tr>
                            <td><strong>Elapsed Time</strong></td>
                            <td>Days</td>
                            <td>1-4 weeks</td>
                            <td>1-6 months</td>
                            <td>6+ months</td>
                        </tr>
                        <tr>
                            <td><strong>User Interaction</strong></td>
                            <td>None (0-click)</td>
                            <td>Standard (frequent)</td>
                            <td>Special</td>
                            <td>Extensive</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Likelihood Categories</h3>
                <ul style="color: var(--text-secondary); padding-left: 20px; line-height: 2;">
                    <li><strong>Very Unlikely:</strong> Average score < 0.6</li>
                    <li><strong>Unlikely:</strong> 0.6 ‚â§ score < 1.2</li>
                    <li><strong>Moderately Likely:</strong> 1.2 ‚â§ score < 1.8</li>
                    <li><strong>Likely:</strong> 1.8 ‚â§ score < 2.4</li>
                    <li><strong>Very Likely:</strong> score ‚â• 2.4</li>
                </ul>

                <h3>STRIDE Threat Categories</h3>
                <table class="threats-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Example in LLM Context</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>S - Spoofing</strong></td>
                            <td>Impersonating something or someone</td>
                            <td>LLM impersonates trusted source in phishing</td>
                        </tr>
                        <tr>
                            <td><strong>T - Tampering</strong></td>
                            <td>Modifying data or code</td>
                            <td>Injecting prompts to modify LLM behavior</td>
                        </tr>
                        <tr>
                            <td><strong>R - Repudiation</strong></td>
                            <td>Denying performed actions</td>
                            <td>LLM actions without audit trail</td>
                        </tr>
                        <tr>
                            <td><strong>I - Information Disclosure</strong></td>
                            <td>Exposing information to unauthorized parties</td>
                            <td>Data exfiltration via prompt injection</td>
                        </tr>
                        <tr>
                            <td><strong>D - Denial of Service</strong></td>
                            <td>Disrupting service availability</td>
                            <td>Overwhelming LLM with malicious queries</td>
                        </tr>
                        <tr>
                            <td><strong>E - Elevation of Privilege</strong></td>
                            <td>Gaining unauthorized access</td>
                            <td>Automatic agent/app invocation attacks</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="export" class="tab-content">
            <div class="card">
                <h2>Export / Import</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Manage your TARA assessment data - export for reporting, import from files, or load sample data.
                </p>

                <div class="export-import-grid">
                    <!-- Export Section -->
                    <div class="export-section">
                        <div class="section-header">
                            <span class="section-icon">üì§</span>
                            <h3>Export Data</h3>
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                            Download your threats in CSV or JSON format.
                        </p>
                        <div class="action-buttons" style="flex-direction: column;">
                            <button class="btn btn-primary" onclick="exportCSV()" style="width: 100%;">
                                <span style="margin-right: 8px;">üìä</span> Export as CSV
                            </button>
                            <button class="btn btn-primary" onclick="exportJSON()" style="width: 100%;">
                                <span style="margin-right: 8px;">üìã</span> Export as JSON
                            </button>
                        </div>
                    </div>

                    <!-- Import Section -->
                    <div class="export-section">
                        <div class="section-header">
                            <span class="section-icon">üì•</span>
                            <h3>Import Data</h3>
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                            Load threats from a previously exported file.
                        </p>
                        <div class="action-buttons" style="flex-direction: column;">
                            <button class="btn btn-import" onclick="importCSV()" style="width: 100%;">
                                <span style="margin-right: 8px;">üìä</span> Import from CSV
                            </button>
                            <button class="btn btn-import" onclick="importJSON()" style="width: 100%;">
                                <span style="margin-right: 8px;">üìã</span> Import from JSON
                            </button>
                        </div>
                    </div>

                    <!-- Load Sample Data Section -->
                    <div class="export-section">
                        <div class="section-header">
                            <span class="section-icon">üìÑ</span>
                            <h3>Load Paper Data</h3>
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                            Load all 14 threats from Table 2 of the paper.
                        </p>
                        <div class="action-buttons" style="flex-direction: column;">
                            <button class="btn btn-primary" onclick="loadAllPaperThreats()" style="width: 100%;">
                                <span style="margin-right: 8px;">üìö</span> Load 14 Threats from Paper
                            </button>
                        </div>
                    </div>

                    <!-- Danger Zone Section -->
                    <div class="export-section danger-zone">
                        <div class="section-header">
                            <span class="section-icon">‚ö†Ô∏è</span>
                            <h3>Danger Zone</h3>
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                            Permanently delete all threats. This action cannot be undone.
                        </p>
                        <div class="action-buttons" style="flex-direction: column;">
                            <button class="btn btn-danger" onclick="deleteAllThreats()" style="width: 100%;">
                                <span style="margin-right: 8px;">üóëÔ∏è</span> Delete All Threats
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel Tab -->
        <div id="admin" class="tab-content">
            <div class="card">
                <h2>‚öôÔ∏è Admin Panel</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Full control over all framework settings. Add, edit, or remove any category, factor, or calculation method.
                </p>

                <div class="admin-grid">
                    <!-- Threat Classes -->
                    <div class="admin-section">
                        <div class="section-header">
                            <span class="section-icon">üè∑Ô∏è</span>
                            <h3>Threat Classes</h3>
                        </div>
                        <p class="admin-desc">Manage threat class categories. All classes can be edited or removed.</p>
                        <div class="admin-category-list" id="threat-classes-list"></div>
                        <div class="admin-input-row">
                            <input type="text" id="new-class-input" placeholder="New threat class..." class="admin-input">
                            <button class="btn btn-primary" onclick="addThreatClass()">+ Add</button>
                        </div>
                    </div>

                    <!-- Impact Categories -->
                    <div class="admin-section">
                        <div class="section-header">
                            <span class="section-icon">üí•</span>
                            <h3>Impact Categories</h3>
                        </div>
                        <p class="admin-desc">Manage impact assessment categories. Each uses 0-4 scale.</p>
                        <div class="admin-category-list" id="impact-categories-list"></div>
                        <div class="admin-input-row">
                            <input type="text" id="new-impact-category" placeholder="New impact category..." class="admin-input">
                            <button class="btn btn-primary" onclick="addImpactCategory()">+ Add</button>
                        </div>
                        <div class="admin-calc-setting">
                            <label>Calculation Method:</label>
                            <select id="impact-calc-method" onchange="updateImpactCalculation(this.value)">
                                <option value="max">Maximum (highest value) ‚≠ê Paper Default</option>
                                <option value="average">Average (mean of values)</option>
                            </select>
                        </div>
                        <div class="admin-default-note">üìÑ Per the paper: Impact Score = MAX of all impact factors</div>
                    </div>

                    <!-- Likelihood Factors -->
                    <div class="admin-section">
                        <div class="section-header">
                            <span class="section-icon">üìä</span>
                            <h3>Likelihood Factors</h3>
                        </div>
                        <p class="admin-desc">Manage likelihood assessment factors. Each uses 0-3 scale.</p>
                        <div class="admin-category-list" id="likelihood-factors-list"></div>
                        <div class="admin-input-row">
                            <input type="text" id="new-likelihood-factor" placeholder="New likelihood factor..." class="admin-input">
                            <button class="btn btn-primary" onclick="addLikelihoodFactor()">+ Add</button>
                        </div>
                        <div class="admin-calc-setting">
                            <label>Calculation Method:</label>
                            <select id="likelihood-calc-method" onchange="updateLikelihoodCalculation(this.value)">
                                <option value="average">Average (mean of values) ‚≠ê Paper Default</option>
                                <option value="max">Maximum (highest value)</option>
                            </select>
                        </div>
                        <div class="admin-default-note">üìÑ Per the paper: Likelihood Score = AVG of all factors</div>
                    </div>

                    <!-- Impact Levels -->
                    <div class="admin-section">
                        <div class="section-header">
                            <span class="section-icon">üìà</span>
                            <h3>Impact Scale (0-4)</h3>
                        </div>
                        <p class="admin-desc">Customize the impact level labels and descriptions.</p>
                        <div class="admin-levels-list" id="impact-levels-list"></div>
                    </div>

                    <!-- Likelihood Levels -->
                    <div class="admin-section">
                        <div class="section-header">
                            <span class="section-icon">üìâ</span>
                            <h3>Likelihood Scale (0-3)</h3>
                        </div>
                        <p class="admin-desc">Customize the likelihood level labels and descriptions.</p>
                        <div class="admin-levels-list" id="likelihood-levels-list"></div>
                    </div>

                    <!-- Risk Levels -->
                    <div class="admin-section full-width">
                        <div class="section-header">
                            <span class="section-icon">üö¶</span>
                            <h3>Risk Levels & Colors</h3>
                        </div>
                        <p class="admin-desc">Customize risk level names and colors. Click color to change.</p>
                        <div class="risk-levels-grid" id="risk-levels-list"></div>
                    </div>

                    <!-- Risk Matrix -->
                    <div class="admin-section full-width">
                        <div class="section-header">
                            <span class="section-icon">üî¢</span>
                            <h3>Risk Matrix Configuration</h3>
                        </div>
                        <p class="admin-desc">Configure how Impact √ó Likelihood maps to Risk Level. Click any cell to change.</p>
                        <div class="admin-matrix-container" id="admin-risk-matrix"></div>
                    </div>

                    <!-- Export/Import Settings Section -->
                    <div class="admin-section full-width">
                        <div class="section-header">
                            <span class="section-icon">üíæ</span>
                            <h3>Export / Import Settings</h3>
                        </div>
                        <p class="admin-desc">Save your customizations to a file or load settings from another user.</p>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="exportSettings()">
                                <span style="margin-right: 8px;">üì§</span> Export Settings
                            </button>
                            <button class="btn btn-import" onclick="importSettings()">
                                <span style="margin-right: 8px;">üì•</span> Import Settings
                            </button>
                        </div>
                    </div>

                    <!-- Reset Section -->
                    <div class="admin-section full-width danger-zone">
                        <div class="section-header">
                            <span class="section-icon">‚ö†Ô∏è</span>
                            <h3>Reset Settings</h3>
                        </div>
                        <p class="admin-desc">Reset all customizations to default values. This cannot be undone.</p>
                        <button class="btn btn-danger" onclick="resetAllSettings()">
                            <span style="margin-right: 8px;">üîÑ</span> Reset All to Defaults
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Threat</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body">
                <!-- Form will be dynamically inserted -->
            </div>
        </div>
    </div>

    <input type="file" id="json-file-input" style="display: none;" accept=".json" onchange="handleJSONImport(event)">
    <input type="file" id="csv-file-input" style="display: none;" accept=".csv" onchange="handleCSVImport(event)">

    <!-- Delete Confirmation Modal -->
    <div class="confirm-modal" id="delete-confirm-modal">
        <div class="confirm-modal-content">
            <h3>‚ö†Ô∏è Delete All Threats?</h3>
            <p>This will permanently delete <strong id="delete-count">0</strong> threats. This action cannot be undone.</p>
            <p style="font-size: 0.9rem;">Type <strong style="color: var(--critical);">DELETE</strong> to confirm:</p>
            <input type="text" id="delete-confirm-input" class="confirm-input" placeholder="Type DELETE to confirm">
            <div class="confirm-buttons">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteAll()" id="confirm-delete-btn" disabled>Delete All</button>
            </div>
        </div>
    </div>

    <script>
        // Toast notification system
        let toastTimeout = null;
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toast-icon');
            const toastMessage = document.getElementById('toast-message');
            
            toast.className = 'toast ' + type;
            toastIcon.textContent = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ';
            toastMessage.textContent = message;
            
            // Clear any existing timeout
            if (toastTimeout) clearTimeout(toastTimeout);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Auto hide after 3 seconds
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Confirmation modal system
        let confirmResolve = null;
        
        function showConfirm(title, message, isDanger = false) {
            return new Promise((resolve) => {
                confirmResolve = resolve;
                
                const modal = document.getElementById('confirm-modal');
                const confirmIcon = document.getElementById('confirm-icon');
                const confirmTitle = document.getElementById('confirm-title');
                const confirmMessage = document.getElementById('confirm-message');
                const confirmBtn = document.getElementById('confirm-btn');
                
                confirmIcon.textContent = isDanger ? '‚ö†Ô∏è' : '‚ùì';
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                
                confirmBtn.className = isDanger ? 'confirm-btn danger' : 'confirm-btn confirm';
                confirmBtn.textContent = isDanger ? 'Delete' : 'Confirm';
                
                modal.classList.add('active');
            });
        }
        
        function closeConfirmModal(result) {
            const modal = document.getElementById('confirm-modal');
            modal.classList.remove('active');
            if (confirmResolve) {
                confirmResolve(result);
                confirmResolve = null;
            }
        }
        
        // Data storage
        let threats = JSON.parse(localStorage.getItem('taraThreats')) || [];
        let customTargets = JSON.parse(localStorage.getItem('taraCustomTargets')) || [];
        let editingThreatId = null;
        
        // Default configurations (used for reset)
        const DEFAULTS = {
            threatClasses: [
                'Short-term Context Poisoning',
                'Long-term Memory Poisoning',
                'Tool Misuse',
                'Automatic Agent Invocation',
                'Automatic App Invocation',
                'Other'
            ],
            impactCategories: [
                { id: 'safety', name: 'Safety', description: 'Physical/mental harm to user' },
                { id: 'privacy', name: 'Privacy', description: 'Data exposure severity' },
                { id: 'financial', name: 'Financial', description: 'Monetary loss' },
                { id: 'operational', name: 'Operational', description: 'Disruption to operations' }
            ],
            impactLevels: [
                { value: 0, name: 'Negligible', description: 'No impact' },
                { value: 1, name: 'Minor', description: 'Minor impact' },
                { value: 2, name: 'Moderate', description: 'Moderate impact' },
                { value: 3, name: 'Severe', description: 'Severe impact' },
                { value: 4, name: 'Critical', description: 'Critical impact' }
            ],
            likelihoodFactors: [
                { id: 'equipment', name: 'Equipment', description: 'Required equipment/tools' },
                { id: 'expertise', name: 'Expertise', description: 'Required expertise level' },
                { id: 'wop', name: 'Window of Opportunity', description: 'Time window available' },
                { id: 'knowledge', name: 'Knowledge', description: 'Required knowledge' },
                { id: 'time', name: 'Elapsed Time', description: 'Time to execute attack' },
                { id: 'interaction', name: 'User Interaction', description: 'User interaction required' }
            ],
            likelihoodLevels: [
                { value: 0, name: 'Difficult', description: 'Very difficult to exploit' },
                { value: 1, name: 'Moderate', description: 'Moderately difficult' },
                { value: 2, name: 'Easy', description: 'Easy to exploit' },
                { value: 3, name: 'Very Easy', description: 'Very easy to exploit' }
            ],
            riskLevels: [
                { name: 'VERY LOW', color: '#22c55e' },
                { name: 'LOW', color: '#84cc16' },
                { name: 'MEDIUM', color: '#eab308' },
                { name: 'HIGH', color: '#f97316' },
                { name: 'VERY HIGH', color: '#ef4444' },
                { name: 'CRITICAL', color: '#7c3aed' }
            ],
            riskMatrix: [
                ['VERY LOW', 'VERY LOW', 'VERY LOW', 'VERY LOW', 'LOW'],
                ['VERY LOW', 'VERY LOW', 'VERY LOW', 'LOW', 'MEDIUM'],
                ['VERY LOW', 'VERY LOW', 'LOW', 'MEDIUM', 'HIGH'],
                ['VERY LOW', 'LOW', 'MEDIUM', 'HIGH', 'VERY HIGH'],
                ['LOW', 'MEDIUM', 'HIGH', 'VERY HIGH', 'CRITICAL']
            ],
            impactCalculation: 'max', // 'max' (paper default) or 'average'
            likelihoodCalculation: 'average' // 'average' (paper default) or 'max'
        };
        
        // Load configurations from localStorage or use defaults
        function loadConfig(key) {
            const stored = localStorage.getItem('taraConfig_' + key);
            return stored ? JSON.parse(stored) : JSON.parse(JSON.stringify(DEFAULTS[key]));
        }
        
        function saveConfig(key, value) {
            localStorage.setItem('taraConfig_' + key, JSON.stringify(value));
        }
        
        // Active configurations
        let config = {
            threatClasses: loadConfig('threatClasses'),
            impactCategories: loadConfig('impactCategories'),
            impactLevels: loadConfig('impactLevels'),
            likelihoodFactors: loadConfig('likelihoodFactors'),
            likelihoodLevels: loadConfig('likelihoodLevels'),
            riskLevels: loadConfig('riskLevels'),
            riskMatrix: loadConfig('riskMatrix'),
            impactCalculation: loadConfig('impactCalculation'),
            likelihoodCalculation: loadConfig('likelihoodCalculation')
        };
        
        // Helper functions to get configurations
        function getImpactCategories() {
            return config.impactCategories;
        }
        
        function getLikelihoodFactors() {
            return config.likelihoodFactors;
        }
        
        function getRiskLevels() {
            return config.riskLevels;
        }
        
        function getThreatClasses() {
            return config.threatClasses;
        }
        
        // Sorting state
        let currentSort = { field: null, direction: 'asc' };
        
        // Filtered threats (for display)
        let filteredThreats = [];
        
        // Theme
        let currentTheme = localStorage.getItem('taraTheme') || 'dark';
        
        // Initialize theme on load
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(currentTheme);
            updateTargetFilter();
            updateAddThreatForm();
            // Apply custom risk colors
            applyCustomRiskColors();
        });
        
        // Theme toggle
        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
            localStorage.setItem('taraTheme', currentTheme);
        }
        
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const themeBtn = document.getElementById('theme-toggle');
            themeBtn.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }
        
        // Update target filter dropdown based on existing threats
        function updateTargetFilter() {
            // Combine targets from threats and custom targets
            const threatTargets = threats.map(t => t.target).filter(t => t);
            const allTargets = [...new Set([...threatTargets, ...customTargets])];
            
            const select = document.getElementById('filter-target');
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">All</option>';
            allTargets.forEach(target => {
                select.innerHTML += `<option value="${target}">${target}</option>`;
            });
            select.value = currentValue;
        }
        
        // =============================================
        // ADMIN PANEL - Full Customization Functions
        // =============================================
        
        // Threat Classes Management
        function addThreatClass() {
            const input = document.getElementById('new-class-input');
            const className = input.value.trim();
            
            if (!className) {
                showToast('Please enter a threat class name.', 'error');
                return;
            }
            
            if (config.threatClasses.includes(className)) {
                showToast('This threat class already exists.', 'error');
                return;
            }
            
            config.threatClasses.push(className);
            saveConfig('threatClasses', config.threatClasses);
            input.value = '';
            
            renderThreatClassesList();
            updateClassDropdown();
            showToast(`Threat class "${className}" added!`, 'success');
        }
        
        async function removeThreatClass(className) {
            if (config.threatClasses.length <= 1) {
                showToast('Cannot remove the last threat class.', 'error');
                return;
            }
            
            const confirmed = await showConfirm(
                'Remove Threat Class',
                `Are you sure you want to remove "${className}"?`,
                true
            );
            if (!confirmed) return;
            
            config.threatClasses = config.threatClasses.filter(c => c !== className);
            saveConfig('threatClasses', config.threatClasses);
            renderThreatClassesList();
            updateClassDropdown();
            showToast(`Threat class "${className}" removed.`, 'success');
        }
        
        function renderThreatClassesList() {
            const container = document.getElementById('threat-classes-list');
            if (!container) return;
            
            let html = '';
            config.threatClasses.forEach(cls => {
                html += `<div class="admin-category-item">
                    <span class="category-name">${cls}</span>
                    <button onclick="removeThreatClass('${cls.replace(/'/g, "\\'")}')" title="Remove">√ó</button>
                </div>`;
            });
            container.innerHTML = html;
        }
        
        // Custom Targets Management
        function addCustomTarget() {
            const input = document.getElementById('new-target-input');
            const targetName = input.value.trim();
            
            if (!targetName) {
                showToast('Please enter a target name.', 'error');
                return;
            }
            
            if (customTargets.includes(targetName)) {
                showToast('This target already exists.', 'error');
                return;
            }
            
            customTargets.push(targetName);
            localStorage.setItem('taraCustomTargets', JSON.stringify(customTargets));
            input.value = '';
            
            renderCustomTargetsList();
            updateTargetFilter();
            showToast(`Target "${targetName}" added!`, 'success');
        }
        
        async function removeCustomTarget(targetName) {
            const confirmed = await showConfirm(
                'Remove Target',
                `Are you sure you want to remove "${targetName}"?`,
                true
            );
            if (!confirmed) return;
            
            customTargets = customTargets.filter(t => t !== targetName);
            localStorage.setItem('taraCustomTargets', JSON.stringify(customTargets));
            renderCustomTargetsList();
            updateTargetFilter();
            showToast(`Target "${targetName}" removed.`, 'success');
        }
        
        function renderCustomTargetsList() {
            const container = document.getElementById('custom-targets-list');
            if (!container) return;
            
            if (customTargets.length === 0) {
                container.innerHTML = '<span style="color: var(--text-secondary); font-size: 0.85rem;">No targets added yet.</span>';
                return;
            }
            
            let html = '';
            customTargets.forEach(target => {
                html += `<span class="admin-tag">
                    ${target}
                    <button onclick="removeCustomTarget('${target.replace(/'/g, "\\'")}')" title="Remove">√ó</button>
                </span>`;
            });
            container.innerHTML = html;
        }
        
        // Impact Categories Management
        function addImpactCategory() {
            const input = document.getElementById('new-impact-category');
            const categoryName = input.value.trim();
            
            if (!categoryName) {
                showToast('Please enter a category name.', 'error');
                return;
            }
            
            if (config.impactCategories.some(c => c.name.toLowerCase() === categoryName.toLowerCase())) {
                showToast('This category already exists.', 'error');
                return;
            }
            
            const newCategory = {
                id: categoryName.toLowerCase().replace(/\s+/g, '_'),
                name: categoryName,
                description: 'Custom impact category'
            };
            
            config.impactCategories.push(newCategory);
            saveConfig('impactCategories', config.impactCategories);
            input.value = '';
            
            renderImpactCategoriesList();
            showToast(`Impact category "${categoryName}" added!`, 'success');
        }
        
        async function removeImpactCategory(categoryId) {
            if (config.impactCategories.length <= 1) {
                showToast('Cannot remove the last impact category.', 'error');
                return;
            }
            
            const category = config.impactCategories.find(c => c.id === categoryId);
            const confirmed = await showConfirm(
                'Remove Impact Category',
                `Are you sure you want to remove "${category?.name}"?`,
                true
            );
            if (!confirmed) return;
            
            config.impactCategories = config.impactCategories.filter(c => c.id !== categoryId);
            saveConfig('impactCategories', config.impactCategories);
            renderImpactCategoriesList();
            showToast(`Impact category removed.`, 'success');
        }
        
        function renderImpactCategoriesList() {
            const container = document.getElementById('impact-categories-list');
            if (!container) return;
            
            let html = '';
            config.impactCategories.forEach(cat => {
                html += `<div class="admin-category-item">
                    <span class="category-name">${cat.name}</span>
                    <span class="category-badge" title="${cat.description}">${cat.description.substring(0, 20)}...</span>
                    <button onclick="removeImpactCategory('${cat.id}')" title="Remove">√ó</button>
                </div>`;
            });
            container.innerHTML = html;
            
            // Set calculation method dropdown
            const calcSelect = document.getElementById('impact-calc-method');
            if (calcSelect) calcSelect.value = config.impactCalculation;
        }
        
        function updateImpactCalculation(method) {
            config.impactCalculation = method;
            saveConfig('impactCalculation', config.impactCalculation);
            const methodName = method === 'max' ? 'Maximum (paper default)' : 'Average';
            showToast(`Impact calculation: ${methodName}`, 'success');
        }
        
        // Likelihood Factors Management
        function addLikelihoodFactor() {
            const input = document.getElementById('new-likelihood-factor');
            const factorName = input.value.trim();
            
            if (!factorName) {
                showToast('Please enter a factor name.', 'error');
                return;
            }
            
            if (config.likelihoodFactors.some(f => f.name.toLowerCase() === factorName.toLowerCase())) {
                showToast('This factor already exists.', 'error');
                return;
            }
            
            const newFactor = {
                id: factorName.toLowerCase().replace(/\s+/g, '_'),
                name: factorName,
                description: 'Custom likelihood factor'
            };
            
            config.likelihoodFactors.push(newFactor);
            saveConfig('likelihoodFactors', config.likelihoodFactors);
            input.value = '';
            
            renderLikelihoodFactorsList();
            showToast(`Likelihood factor "${factorName}" added!`, 'success');
        }
        
        async function removeLikelihoodFactor(factorId) {
            if (config.likelihoodFactors.length <= 1) {
                showToast('Cannot remove the last likelihood factor.', 'error');
                return;
            }
            
            const factor = config.likelihoodFactors.find(f => f.id === factorId);
            const confirmed = await showConfirm(
                'Remove Likelihood Factor',
                `Are you sure you want to remove "${factor?.name}"?`,
                true
            );
            if (!confirmed) return;
            
            config.likelihoodFactors = config.likelihoodFactors.filter(f => f.id !== factorId);
            saveConfig('likelihoodFactors', config.likelihoodFactors);
            renderLikelihoodFactorsList();
            showToast(`Likelihood factor removed.`, 'success');
        }
        
        function renderLikelihoodFactorsList() {
            const container = document.getElementById('likelihood-factors-list');
            if (!container) return;
            
            let html = '';
            config.likelihoodFactors.forEach(factor => {
                html += `<div class="admin-category-item">
                    <span class="category-name">${factor.name}</span>
                    <span class="category-badge" title="${factor.description}">${factor.description.substring(0, 20)}...</span>
                    <button onclick="removeLikelihoodFactor('${factor.id}')" title="Remove">√ó</button>
                </div>`;
            });
            container.innerHTML = html;
            
            // Set calculation method dropdown
            const calcSelect = document.getElementById('likelihood-calc-method');
            if (calcSelect) calcSelect.value = config.likelihoodCalculation;
        }
        
        function updateLikelihoodCalculation(method) {
            config.likelihoodCalculation = method;
            saveConfig('likelihoodCalculation', config.likelihoodCalculation);
            const methodName = method === 'average' ? 'Average (paper default)' : 'Maximum';
            showToast(`Likelihood calculation: ${methodName}`, 'success');
        }
        
        // Impact Levels Management
        function renderImpactLevelsList() {
            const container = document.getElementById('impact-levels-list');
            if (!container) return;
            
            let html = '';
            config.impactLevels.forEach((level, index) => {
                html += `<div class="admin-level-item">
                    <span class="level-value">${level.value}</span>
                    <input type="text" value="${level.name}" onchange="updateImpactLevelName(${index}, this.value)" placeholder="Level name">
                </div>`;
            });
            container.innerHTML = html;
        }
        
        function updateImpactLevelName(index, name) {
            config.impactLevels[index].name = name;
            saveConfig('impactLevels', config.impactLevels);
        }
        
        // Likelihood Levels Management
        function renderLikelihoodLevelsList() {
            const container = document.getElementById('likelihood-levels-list');
            if (!container) return;
            
            let html = '';
            config.likelihoodLevels.forEach((level, index) => {
                html += `<div class="admin-level-item">
                    <span class="level-value">${level.value}</span>
                    <input type="text" value="${level.name}" onchange="updateLikelihoodLevelName(${index}, this.value)" placeholder="Level name">
                </div>`;
            });
            container.innerHTML = html;
        }
        
        function updateLikelihoodLevelName(index, name) {
            config.likelihoodLevels[index].name = name;
            saveConfig('likelihoodLevels', config.likelihoodLevels);
        }
        
        // Risk Levels Management
        function renderRiskLevelsList() {
            const container = document.getElementById('risk-levels-list');
            if (!container) return;
            
            let html = '';
            config.riskLevels.forEach((level, index) => {
                html += `<div class="risk-level-item">
                    <input type="color" class="risk-level-color" value="${level.color}" 
                           onchange="updateRiskLevelColor(${index}, this.value)" title="Click to change color">
                    <input type="text" value="${level.name}" onchange="updateRiskLevelName(${index}, this.value)" 
                           style="color: ${level.color}; font-weight: 500;">
                </div>`;
            });
            container.innerHTML = html;
        }
        
        function updateRiskLevelColor(index, color) {
            config.riskLevels[index].color = color;
            saveConfig('riskLevels', config.riskLevels);
            applyCustomRiskColors();
            renderRiskLevelsList();
            showToast('Risk level color updated!', 'success');
        }
        
        function updateRiskLevelName(index, name) {
            const oldName = config.riskLevels[index].name;
            config.riskLevels[index].name = name;
            saveConfig('riskLevels', config.riskLevels);
            
            // Update risk matrix to use new name
            config.riskMatrix = config.riskMatrix.map(row => 
                row.map(cell => cell === oldName ? name : cell)
            );
            saveConfig('riskMatrix', config.riskMatrix);
            renderAdminRiskMatrix();
        }
        
        function applyCustomRiskColors() {
            const levels = config.riskLevels;
            const root = document.documentElement;
            
            const cssVarNames = ['--very-low', '--low', '--medium', '--high', '--very-high', '--critical'];
            levels.forEach((level, index) => {
                if (cssVarNames[index]) {
                    root.style.setProperty(cssVarNames[index], level.color);
                }
            });
        }
        
        // Risk Matrix Management
        function renderAdminRiskMatrix() {
            const container = document.getElementById('admin-risk-matrix');
            if (!container) return;
            
            const impactLabels = config.impactLevels.map(l => l.name);
            const likelihoodLabels = ['Very Unlikely', 'Unlikely', 'Moderately Likely', 'Likely', 'Very Likely'];
            
            let html = '<div class="admin-matrix">';
            
            // Header row
            html += '<div class="admin-matrix-cell header"></div>';
            impactLabels.forEach(label => {
                html += `<div class="admin-matrix-cell header">${label}</div>`;
            });
            
            // Matrix rows (reversed so Very Likely is at top)
            for (let l = 4; l >= 0; l--) {
                html += `<div class="admin-matrix-cell label">${likelihoodLabels[l]}</div>`;
                
                for (let i = 0; i <= 4; i++) {
                    const riskLevel = config.riskMatrix[l][i];
                    const levelConfig = config.riskLevels.find(r => r.name === riskLevel) || config.riskLevels[0];
                    
                    html += `<div class="admin-matrix-cell" 
                                  style="background: ${levelConfig.color}; color: white;"
                                  onclick="cycleMatrixCell(${l}, ${i})"
                                  title="Click to change">${riskLevel}</div>`;
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function cycleMatrixCell(likelihoodIdx, impactIdx) {
            const currentLevel = config.riskMatrix[likelihoodIdx][impactIdx];
            const currentIndex = config.riskLevels.findIndex(r => r.name === currentLevel);
            const nextIndex = (currentIndex + 1) % config.riskLevels.length;
            
            config.riskMatrix[likelihoodIdx][impactIdx] = config.riskLevels[nextIndex].name;
            saveConfig('riskMatrix', config.riskMatrix);
            renderAdminRiskMatrix();
        }
        
        // Export/Import Settings
        function exportSettings() {
            const settings = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                config: config,
                customTargets: customTargets
            };
            
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tara-settings-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Settings exported successfully!', 'success');
        }
        
        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const settings = JSON.parse(text);
                    
                    if (!settings.version) {
                        showToast('Invalid settings file format.', 'error');
                        return;
                    }
                    
                    const confirmed = await showConfirm(
                        'Import Settings',
                        'This will replace your current settings with the imported ones. Continue?',
                        false
                    );
                    if (!confirmed) return;
                    
                    // Import v2.0 format
                    if (settings.config) {
                        Object.keys(settings.config).forEach(key => {
                            config[key] = settings.config[key];
                            saveConfig(key, config[key]);
                        });
                    }
                    
                    if (settings.customTargets) {
                        customTargets = settings.customTargets;
                        localStorage.setItem('taraCustomTargets', JSON.stringify(customTargets));
                    }
                    
                    applyCustomRiskColors();
                    renderAdminPanel();
                    updateClassDropdown();
                    updateTargetFilter();
                    showToast('Settings imported successfully!', 'success');
                    
                } catch (error) {
                    showToast('Error reading settings file.', 'error');
                    console.error(error);
                }
            };
            input.click();
        }
        
        // Reset all settings
        async function resetAllSettings() {
            const confirmed = await showConfirm(
                'Reset All Settings',
                'This will reset ALL settings to defaults including threat classes, categories, factors, colors, and the risk matrix. This cannot be undone!',
                true
            );
            if (!confirmed) return;
            
            // Clear all config from localStorage
            Object.keys(DEFAULTS).forEach(key => {
                localStorage.removeItem('taraConfig_' + key);
                config[key] = JSON.parse(JSON.stringify(DEFAULTS[key]));
            });
            
            customTargets = [];
            localStorage.removeItem('taraCustomTargets');
            
            // Reset CSS colors
            const root = document.documentElement;
            ['--very-low', '--low', '--medium', '--high', '--very-high', '--critical'].forEach(v => {
                root.style.removeProperty(v);
            });
            
            renderAdminPanel();
            updateClassDropdown();
            updateTargetFilter();
            showToast('All settings reset to defaults!', 'success');
        }
        
        // Render entire admin panel
        function renderAdminPanel() {
            renderThreatClassesList();
            renderImpactCategoriesList();
            renderLikelihoodFactorsList();
            renderImpactLevelsList();
            renderLikelihoodLevelsList();
            renderRiskLevelsList();
            renderAdminRiskMatrix();
        }
        
        // Update the class dropdown in the Add Threat form
        function updateClassDropdown() {
            const select = document.getElementById('threat-class');
            if (!select) return;
            
            const currentValue = select.value;
            
            // Use threat classes from config
            const allClasses = config.threatClasses;
            
            select.innerHTML = '<option value="">Select a threat class...</option>';
            allClasses.forEach(cls => {
                select.innerHTML += `<option value="${cls}">${cls}</option>`;
            });
            
            // Restore previous selection if still valid
            if (currentValue && allClasses.includes(currentValue)) {
                select.value = currentValue;
            }
        }
        
        // Update impact dropdowns with configurable level names
        // Dynamic form rendering functions

        // Update the Add Threat form with all configurable values
        function updateAddThreatForm() {
            updateClassDropdown();
            renderImpactCategoryInputs();
            renderLikelihoodFactorInputs();
            renderResidualFactorInputs();
        }
        
        // Dynamically render residual likelihood factor dropdowns
        function renderResidualFactorInputs() {
            const container = document.getElementById('residual-factors-container');
            if (!container) return;
            
            let html = '';
            config.likelihoodFactors.forEach(factor => {
                html += `<div class="form-group">
                    <label>${factor.name} (After Mitigation)</label>
                    <select id="residual-${factor.id}" onchange="calculateResidualRisk()">`;
                
                // Start with lowest value selected (assuming mitigation reduces likelihood)
                config.likelihoodLevels.forEach((level, idx) => {
                    const selected = idx === 0 ? ' selected' : '';
                    html += `<option value="${level.value}"${selected}>${level.name} (${level.value})</option>`;
                });
                
                html += `</select>
                </div>`;
            });
            
            container.innerHTML = html;
        }
        
        // Dynamically render impact category dropdowns
        function renderImpactCategoryInputs() {
            const container = document.getElementById('impact-categories-container');
            if (!container) return;
            
            let html = '';
            config.impactCategories.forEach(cat => {
                html += `<div class="form-group">
                    <label>${cat.name} Impact
                        <span class="tooltip">
                            <span class="info-icon">?</span>
                            <span class="tooltip-text">${cat.description || cat.name + ' impact assessment'}</span>
                        </span>
                    </label>
                    <select id="impact-${cat.id}" onchange="calculateScores()">`;
                
                config.impactLevels.forEach(level => {
                    html += `<option value="${level.value}">${level.name} (${level.value})</option>`;
                });
                
                html += `</select>
                </div>`;
            });
            
            container.innerHTML = html;
            
            // Update tooltip
            const tooltipText = document.getElementById('impact-tooltip-text');
            if (tooltipText) {
                const method = config.impactCalculation === 'max' ? 'highest score (MAX)' : 'average score (AVG)';
                tooltipText.innerHTML = `Impact is determined by the <strong>${method}</strong> of all categories.`;
            }
        }
        
        // Dynamically render likelihood factor dropdowns
        function renderLikelihoodFactorInputs() {
            const container = document.getElementById('likelihood-factors-container');
            if (!container) return;
            
            let html = '';
            config.likelihoodFactors.forEach(factor => {
                html += `<div class="form-group">
                    <label>${factor.name}
                        <span class="tooltip">
                            <span class="info-icon">?</span>
                            <span class="tooltip-text">${factor.description || factor.name + ' assessment'}</span>
                        </span>
                    </label>
                    <select id="likelihood-${factor.id}" onchange="calculateScores()">`;
                
                // Likelihood levels in reverse order (highest first for easier selection)
                [...config.likelihoodLevels].reverse().forEach(level => {
                    html += `<option value="${level.value}">${level.name} (${level.value})</option>`;
                });
                
                html += `</select>
                </div>`;
            });
            
            container.innerHTML = html;
            
            // Update tooltip
            const tooltipText = document.getElementById('likelihood-tooltip-text');
            if (tooltipText) {
                const method = config.likelihoodCalculation === 'average' ? 'average score (AVG)' : 'highest score (MAX)';
                tooltipText.innerHTML = `Likelihood is calculated as the <strong>${method}</strong> of all factors. Higher scores = more likely/practical attack.`;
            }
        }
        
        // Filter and search threats
        function filterThreats() {
            const searchTerm = document.getElementById('threat-search')?.value.toLowerCase() || '';
            const riskFilter = document.getElementById('filter-risk')?.value || '';
            const strideFilter = document.getElementById('filter-stride')?.value || '';
            const targetFilter = document.getElementById('filter-target')?.value || '';
            
            filteredThreats = threats.filter(threat => {
                // Search filter - search across multiple fields
                const matchesSearch = !searchTerm || 
                    (threat.id && threat.id.toLowerCase().includes(searchTerm)) ||
                    (threat.name && threat.name.toLowerCase().includes(searchTerm)) ||
                    (threat.description && threat.description.toLowerCase().includes(searchTerm)) ||
                    (threat.threatClass && threat.threatClass.toLowerCase().includes(searchTerm)) ||
                    (threat.stride && threat.stride.toLowerCase().includes(searchTerm)) ||
                    (threat.target && threat.target.toLowerCase().includes(searchTerm));
                
                // Risk filter - exact match (dropdown values are uppercase to match data)
                const matchesRisk = !riskFilter || threat.riskLevel === riskFilter;
                
                // STRIDE filter
                const matchesStride = !strideFilter || (threat.stride && threat.stride.includes(strideFilter));
                
                // Target filter
                const matchesTarget = !targetFilter || threat.target === targetFilter;
                
                return matchesSearch && matchesRisk && matchesStride && matchesTarget;
            });
            
            // Apply current sort
            if (currentSort.field) {
                sortFilteredThreats(currentSort.field, currentSort.direction);
            }
            
            renderThreatsList();
        }
        
        // Sorting functionality
        function sortBy(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            sortFilteredThreats(field, currentSort.direction);
            renderThreatsList();
        }
        
        function sortFilteredThreats(field, direction) {
            const modifier = direction === 'asc' ? 1 : -1;
            
            filteredThreats.sort((a, b) => {
                let valA, valB;
                
                switch (field) {
                    case 'id':
                        // Extract number from ID like T1, T2, etc.
                        valA = parseInt(a.id?.replace(/\D/g, '')) || 0;
                        valB = parseInt(b.id?.replace(/\D/g, '')) || 0;
                        break;
                    case 'name':
                        valA = a.name?.toLowerCase() || '';
                        valB = b.name?.toLowerCase() || '';
                        break;
                    case 'impactScore':
                        valA = a.impactScore || 0;
                        valB = b.impactScore || 0;
                        break;
                    case 'likelihoodScore':
                        valA = a.likelihoodScore || 0;
                        valB = b.likelihoodScore || 0;
                        break;
                    case 'risk':
                        const riskOrder = { 'Critical': 6, 'Very High': 5, 'High': 4, 'Medium': 3, 'Low': 2, 'Very Low': 1 };
                        valA = riskOrder[a.riskLevel] || 0;
                        valB = riskOrder[b.riskLevel] || 0;
                        break;
                    case 'residual':
                        const residualOrder = { 'Critical': 6, 'Very High': 5, 'High': 4, 'Medium': 3, 'Low': 2, 'Very Low': 1 };
                        valA = residualOrder[a.residualRiskLevel] || 0;
                        valB = residualOrder[b.residualRiskLevel] || 0;
                        break;
                    default:
                        valA = a[field] || '';
                        valB = b[field] || '';
                }
                
                if (valA < valB) return -1 * modifier;
                if (valA > valB) return 1 * modifier;
                return 0;
            });
        }
        
        // Duplicate threat
        function duplicateThreat(threatId) {
            const original = threats.find(t => t.id === threatId);
            if (!original) return;
            
            // Find next available ID
            let newId = original.id + '-copy';
            let counter = 1;
            while (threats.find(t => t.id === newId)) {
                newId = `${original.id}-copy${counter}`;
                counter++;
            }
            
            const duplicate = JSON.parse(JSON.stringify(original));
            duplicate.id = newId;
            duplicate.name = `${original.name} (Copy)`;
            
            threats.push(duplicate);
            saveThreatsToStorage();
            updateDashboard();
            filterThreats();
            renderThreatsOnMatrix();
        }

        // Tab navigation
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
            
            if (tabId === 'dashboard') updateDashboard();
            if (tabId === 'threats-list') {
                filteredThreats = [...threats];
                filterThreats();
            }
            if (tabId === 'risk-matrix') renderThreatsOnMatrix();
            if (tabId === 'add-threat') updateAddThreatForm();
            if (tabId === 'admin') renderAdminPanel();
        }

        // STRIDE toggle
        function toggleStride(element) {
            element.classList.toggle('selected');
        }

        function getSelectedStride() {
            const selected = document.querySelectorAll('.stride-item.selected');
            return Array.from(selected).map(el => el.dataset.stride).join('');
        }

        // Collapsible
        function toggleCollapsible(element) {
            element.classList.toggle('active');
            const content = element.nextElementSibling;
            content.classList.toggle('show');
        }

        // Score calculations
        function calculateScores() {
            // Impact - dynamically read from config-based dropdowns
            const impactValues = [];
            config.impactCategories.forEach(cat => {
                const el = document.getElementById('impact-' + cat.id);
                if (el) impactValues.push(parseInt(el.value) || 0);
            });
            
            let impactScore = 0;
            if (impactValues.length > 0) {
                if (config.impactCalculation === 'max') {
                    impactScore = Math.max(...impactValues);
                } else {
                    impactScore = Math.round(impactValues.reduce((a, b) => a + b, 0) / impactValues.length);
                }
            }
            document.getElementById('impact-score').textContent = impactScore;
            
            // Use configurable impact level names
            const impactLabel = config.impactLevels.find(l => l.value === impactScore)?.name?.toUpperCase() || 'UNKNOWN';
            const impactClasses = ['risk-very-low', 'risk-low', 'risk-medium', 'risk-high', 'risk-critical'];
            
            const impactCategoryEl = document.getElementById('impact-category');
            impactCategoryEl.textContent = impactLabel;
            impactCategoryEl.className = 'risk-badge ' + impactClasses[Math.min(impactScore, 4)];

            // Likelihood - dynamically read from config-based dropdowns
            const likelihoodValues = [];
            config.likelihoodFactors.forEach(factor => {
                const el = document.getElementById('likelihood-' + factor.id);
                if (el) likelihoodValues.push(parseInt(el.value) || 0);
            });
            
            let likelihoodScore = 0;
            if (likelihoodValues.length > 0) {
                if (config.likelihoodCalculation === 'max') {
                    likelihoodScore = Math.max(...likelihoodValues);
                } else {
                    likelihoodScore = likelihoodValues.reduce((a, b) => a + b, 0) / likelihoodValues.length;
                }
            }
            document.getElementById('likelihood-score').textContent = likelihoodScore.toFixed(2);
            
            let likelihoodCategory, likelihoodClass;
            if (likelihoodScore < 0.6) {
                likelihoodCategory = 'VERY UNLIKELY';
                likelihoodClass = 'risk-very-low';
            } else if (likelihoodScore < 1.2) {
                likelihoodCategory = 'UNLIKELY';
                likelihoodClass = 'risk-low';
            } else if (likelihoodScore < 1.8) {
                likelihoodCategory = 'MODERATELY LIKELY';
                likelihoodClass = 'risk-medium';
            } else if (likelihoodScore < 2.4) {
                likelihoodCategory = 'LIKELY';
                likelihoodClass = 'risk-high';
            } else {
                likelihoodCategory = 'VERY LIKELY';
                likelihoodClass = 'risk-critical';
            }
            
            const likelihoodCategoryEl = document.getElementById('likelihood-category');
            likelihoodCategoryEl.textContent = likelihoodCategory;
            likelihoodCategoryEl.className = 'risk-badge ' + likelihoodClass;

            // Calculate final risk
            calculateFinalRisk(impactScore, likelihoodScore);
        }

        function calculateFinalRisk(impactScore, likelihoodScore) {
            // Use configurable risk matrix
            const riskMatrix = config.riskMatrix;
            
            let likelihoodIndex;
            if (likelihoodScore < 0.6) likelihoodIndex = 0;
            else if (likelihoodScore < 1.2) likelihoodIndex = 1;
            else if (likelihoodScore < 1.8) likelihoodIndex = 2;
            else if (likelihoodScore < 2.4) likelihoodIndex = 3;
            else likelihoodIndex = 4;
            
            const riskLevel = riskMatrix[likelihoodIndex][impactScore];
            
            document.getElementById('final-risk-score').textContent = riskLevel;
            
            const riskBadge = document.getElementById('final-risk-badge');
            riskBadge.textContent = riskLevel;
            riskBadge.className = 'risk-badge risk-' + riskLevel.toLowerCase().replace(' ', '-');
        }

        function calculateResidualRisk() {
            // Dynamically read from config-based residual dropdowns
            const residualValues = [];
            config.likelihoodFactors.forEach(factor => {
                const el = document.getElementById('residual-' + factor.id);
                if (el) residualValues.push(parseInt(el.value) || 0);
            });
            
            let likelihoodScore = 0;
            if (residualValues.length > 0) {
                if (config.likelihoodCalculation === 'max') {
                    likelihoodScore = Math.max(...residualValues);
                } else {
                    likelihoodScore = residualValues.reduce((a, b) => a + b, 0) / residualValues.length;
                }
            }
            document.getElementById('residual-likelihood-score').textContent = likelihoodScore.toFixed(2);
            
            let likelihoodCategory, likelihoodClass;
            if (likelihoodScore < 0.6) {
                likelihoodCategory = 'VERY UNLIKELY';
                likelihoodClass = 'risk-very-low';
            } else if (likelihoodScore < 1.2) {
                likelihoodCategory = 'UNLIKELY';
                likelihoodClass = 'risk-low';
            } else if (likelihoodScore < 1.8) {
                likelihoodCategory = 'MODERATELY LIKELY';
                likelihoodClass = 'risk-medium';
            } else if (likelihoodScore < 2.4) {
                likelihoodCategory = 'LIKELY';
                likelihoodClass = 'risk-high';
            } else {
                likelihoodCategory = 'VERY LIKELY';
                likelihoodClass = 'risk-critical';
            }
            
            const residualBadge = document.getElementById('residual-risk-badge');
            residualBadge.textContent = likelihoodCategory;
            residualBadge.className = 'risk-badge ' + likelihoodClass;
        }

        // Save threat
        function saveThreat() {
            // Dynamically collect impact values from config-based dropdowns
            const impact = {};
            const impactValues = [];
            config.impactCategories.forEach(cat => {
                const el = document.getElementById('impact-' + cat.id);
                const value = el ? parseInt(el.value) || 0 : 0;
                impact[cat.id] = value;
                impactValues.push(value);
            });
            
            // Dynamically collect likelihood values from config-based dropdowns
            const likelihood = {};
            const likelihoodValues = [];
            config.likelihoodFactors.forEach(factor => {
                const el = document.getElementById('likelihood-' + factor.id);
                const value = el ? parseInt(el.value) || 0 : 0;
                likelihood[factor.id] = value;
                likelihoodValues.push(value);
            });
            
            // Dynamically collect residual likelihood values
            const residualLikelihood = {};
            const residualValues = [];
            config.likelihoodFactors.forEach(factor => {
                const el = document.getElementById('residual-' + factor.id);
                const value = el ? parseInt(el.value) || 0 : 0;
                residualLikelihood[factor.id] = value;
                residualValues.push(value);
            });
            
            const threat = {
                id: document.getElementById('threat-id').value || 'T' + (threats.length + 1),
                name: document.getElementById('threat-name').value,
                description: document.getElementById('threat-description').value,
                attackScenario: document.getElementById('attack-scenario').value,
                threatClass: document.getElementById('threat-class').value,
                target: document.getElementById('threat-target').value,
                stride: getSelectedStride(),
                impact: impact,
                likelihood: likelihood,
                mitigations: document.getElementById('mitigations').value,
                residualLikelihood: residualLikelihood,
                createdAt: new Date().toISOString()
            };

            // Calculate impact score based on config
            if (config.impactCalculation === 'max') {
                threat.impactScore = impactValues.length > 0 ? Math.max(...impactValues) : 0;
            } else {
                threat.impactScore = impactValues.length > 0 ? Math.round(impactValues.reduce((a, b) => a + b, 0) / impactValues.length) : 0;
            }
            
            // Calculate likelihood score based on config
            if (config.likelihoodCalculation === 'max') {
                threat.likelihoodScore = likelihoodValues.length > 0 ? Math.max(...likelihoodValues) : 0;
            } else {
                threat.likelihoodScore = likelihoodValues.length > 0 ? likelihoodValues.reduce((a, b) => a + b, 0) / likelihoodValues.length : 0;
            }
            threat.riskLevel = calculateRiskLevel(threat.impactScore, threat.likelihoodScore);
            
            // Calculate residual likelihood score based on config
            if (config.likelihoodCalculation === 'max') {
                threat.residualLikelihoodScore = residualValues.length > 0 ? Math.max(...residualValues) : 0;
            } else {
                threat.residualLikelihoodScore = residualValues.length > 0 ? residualValues.reduce((a, b) => a + b, 0) / residualValues.length : 0;
            }
            threat.residualRiskLevel = calculateRiskLevel(threat.impactScore, threat.residualLikelihoodScore);

            if (editingThreatId) {
                const index = threats.findIndex(t => t.id === editingThreatId);
                if (index !== -1) threats[index] = threat;
                editingThreatId = null;
            } else {
                threats.push(threat);
            }
            
            saveThreatsToStorage();
            updateTargetFilter();
            clearForm();
            alert('Threat saved successfully!');
            showTab('threats-list');
        }
        
        function saveThreatsToStorage() {
            localStorage.setItem('taraThreats', JSON.stringify(threats));
        }

        function calculateRiskLevel(impactScore, likelihoodScore) {
            // Use configurable risk matrix
            const riskMatrix = config.riskMatrix;
            
            let likelihoodIndex;
            if (likelihoodScore < 0.6) likelihoodIndex = 0;
            else if (likelihoodScore < 1.2) likelihoodIndex = 1;
            else if (likelihoodScore < 1.8) likelihoodIndex = 2;
            else if (likelihoodScore < 2.4) likelihoodIndex = 3;
            else likelihoodIndex = 4;
            
            return riskMatrix[likelihoodIndex][impactScore];
        }

        function clearForm() {
            document.getElementById('threat-id').value = '';
            document.getElementById('threat-name').value = '';
            document.getElementById('threat-description').value = '';
            document.getElementById('attack-scenario').value = '';
            document.getElementById('threat-class').value = '';
            document.getElementById('threat-target').value = '';
            document.getElementById('mitigations').value = '';
            
            document.querySelectorAll('.stride-item').forEach(el => el.classList.remove('selected'));
            
            // Clear impact dropdowns dynamically
            config.impactCategories.forEach(cat => {
                const el = document.getElementById('impact-' + cat.id);
                if (el) el.value = '0';
            });
            
            // Clear likelihood dropdowns dynamically (set to highest value)
            const maxLikelihood = Math.max(...config.likelihoodLevels.map(l => l.value));
            config.likelihoodFactors.forEach(factor => {
                const el = document.getElementById('likelihood-' + factor.id);
                if (el) el.value = maxLikelihood.toString();
            });
            
            // Clear residual likelihood dropdowns
            config.likelihoodFactors.forEach(factor => {
                const el = document.getElementById('residual-' + factor.id);
                if (el) el.value = '0';
            });
            
            editingThreatId = null;
            calculateScores();
        }

        // Expanded view state
        let expandedView = false;
        let expandedThreats = new Set();

        // STRIDE full names mapping
        const strideFullNames = {
            'S': 'Spoofing',
            'T': 'Tampering',
            'R': 'Repudiation',
            'I': 'Information Disclosure',
            'D': 'Denial of Service',
            'E': 'Elevation of Privilege',
            'O': 'Other'
        };

        function getStrideFullName(strideCode) {
            if (!strideCode) return '-';
            return strideCode.split('').map(c => strideFullNames[c] || c).join(', ');
        }

        function toggleExpandAll() {
            expandedView = !expandedView;
            document.getElementById('expand-toggle').classList.toggle('active', expandedView);
            renderThreatsList();
        }

        function toggleThreatExpand(id, event) {
            event.stopPropagation();
            if (expandedThreats.has(id)) {
                expandedThreats.delete(id);
            } else {
                expandedThreats.add(id);
            }
            renderThreatsList();
        }

        // Render threats list
        function renderThreatsList() {
            const container = document.getElementById('threats-container');
            
            // Initialize filtered threats if not filtering
            if (filteredThreats.length === 0 && threats.length > 0) {
                filteredThreats = [...threats];
            }
            
            if (threats.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No threats added yet.</p>';
                return;
            }
            
            if (filteredThreats.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No threats match your search/filter criteria.</p>';
                return;
            }
            
            // Check if expanded view (full table) or compact view (expandable rows)
            if (expandedView) {
                renderExpandedTable(container);
            } else {
                renderCompactTable(container);
            }
        }

        function renderCompactTable(container) {
            let html = '<table class="threats-table"><thead><tr>';
            html += '<th style="width: 30px;"></th>';
            html += `<th class="sortable ${currentSort.field === 'id' ? 'sort-' + currentSort.direction : ''}" onclick="sortBy('id')">ID<span class="sort-icon"></span></th>`;
            html += `<th class="sortable ${currentSort.field === 'name' ? 'sort-' + currentSort.direction : ''}" onclick="sortBy('name')">Name<span class="sort-icon"></span></th>`;
            html += '<th>STRIDE</th>';
            html += `<th class="sortable ${currentSort.field === 'impactScore' ? 'sort-' + currentSort.direction : ''}" onclick="sortBy('impactScore')">Impact<span class="sort-icon"></span></th>`;
            html += `<th class="sortable ${currentSort.field === 'likelihoodScore' ? 'sort-' + currentSort.direction : ''}" onclick="sortBy('likelihoodScore')">Likelihood<span class="sort-icon"></span></th>`;
            html += `<th class="sortable ${currentSort.field === 'risk' ? 'sort-' + currentSort.direction : ''}" onclick="sortBy('risk')">Risk<span class="sort-icon"></span></th>`;
            html += `<th class="sortable ${currentSort.field === 'residual' ? 'sort-' + currentSort.direction : ''}" onclick="sortBy('residual')">Residual<span class="sort-icon"></span></th>`;
            html += '<th>Actions</th>';
            html += '</tr></thead><tbody>';
            
            filteredThreats.forEach(threat => {
                const isExpanded = expandedThreats.has(threat.id);
                html += `<tr class="threat-row" onclick="toggleThreatExpand('${threat.id}', event)">
                    <td><span class="expand-icon ${isExpanded ? 'rotated' : ''}">‚ñ∂</span></td>
                    <td><strong>${threat.id}</strong></td>
                    <td>${threat.name || 'Unnamed'}</td>
                    <td title="${getStrideFullName(threat.stride)}">${threat.stride || '-'}</td>
                    <td><span class="risk-badge risk-${getImpactClass(threat.impactScore)}">${getImpactLabel(threat.impactScore)}</span></td>
                    <td><span class="risk-badge risk-${getLikelihoodClass(threat.likelihoodScore)}">${getLikelihoodLabel(threat.likelihoodScore)}</span></td>
                    <td><span class="risk-badge risk-${threat.riskLevel.toLowerCase().replace(' ', '-')}">${threat.riskLevel}</span></td>
                    <td><span class="risk-badge risk-${threat.residualRiskLevel.toLowerCase().replace(' ', '-')}">${threat.residualRiskLevel}</span></td>
                    <td class="threat-actions">
                        <button class="btn btn-secondary" onclick="event.stopPropagation(); duplicateThreat('${threat.id}')" title="Duplicate">üìã</button>
                        <button class="btn btn-secondary" onclick="event.stopPropagation(); editThreat('${threat.id}')">Edit</button>
                        <button class="btn btn-danger" onclick="event.stopPropagation(); deleteThreat('${threat.id}')">Del</button>
                    </td>
                </tr>`;
                
                // Expanded details row
                html += `<tr class="threat-details ${isExpanded ? 'show' : ''}" id="details-${threat.id}">
                    <td colspan="9">
                        <div class="details-grid">
                            <div class="details-section">
                                <h4>Overview</h4>
                                <div class="score-row"><span>Threat Class:</span><span>${threat.threatClass || '-'}</span></div>
                                <div class="score-row"><span>Target:</span><span>${threat.target || '-'}</span></div>
                                <div class="score-row"><span>STRIDE:</span><span>${getStrideFullName(threat.stride)}</span></div>
                            </div>
                            <div class="details-section">
                                <h4>Description</h4>
                                <p>${threat.description || 'No description provided.'}</p>
                            </div>
                            <div class="details-section" style="grid-column: span 2;">
                                <h4>Attack Scenario</h4>
                                <p>${threat.attackScenario || 'No attack scenario provided.'}</p>
                            </div>
                            <div class="details-section">
                                <h4>Impact Assessment</h4>
                                ${renderImpactDetails(threat)}
                                <div class="score-row" style="font-weight: bold; margin-top: 10px; border-top: 2px solid var(--accent); padding-top: 10px;">
                                    <span>Impact Score:</span>
                                    <span><span class="risk-badge risk-${getImpactClass(threat.impactScore)}">${getImpactLabel(threat.impactScore)} (${threat.impactScore})</span></span>
                                </div>
                            </div>
                            <div class="details-section">
                                <h4>Likelihood Assessment</h4>
                                ${renderLikelihoodDetails(threat)}
                                <div class="score-row" style="font-weight: bold; margin-top: 10px; border-top: 2px solid var(--accent); padding-top: 10px;">
                                    <span>Likelihood Score:</span>
                                    <span><span class="risk-badge risk-${getLikelihoodClass(threat.likelihoodScore)}">${getLikelihoodLabel(threat.likelihoodScore)} (${threat.likelihoodScore.toFixed(2)})</span></span>
                                </div>
                            </div>
                            <div class="details-section">
                                <h4>Risk Assessment</h4>
                                <div class="score-row" style="font-weight: bold;">
                                    <span>Risk Level:</span>
                                    <span><span class="risk-badge risk-${threat.riskLevel.toLowerCase().replace(' ', '-')}">${threat.riskLevel}</span></span>
                                </div>
                                <h4 style="margin-top: 15px;">Mitigations</h4>
                                <p style="font-size: 0.85rem;">${threat.mitigations || 'No mitigations specified.'}</p>
                            </div>
                            <div class="details-section">
                                <h4>Residual Risk (After Mitigations)</h4>
                                <div class="score-row"><span>Residual Likelihood:</span><span>${threat.residualLikelihoodScore.toFixed(2)} (${getLikelihoodLabel(threat.residualLikelihoodScore)})</span></div>
                                <div class="score-row" style="font-weight: bold; margin-top: 10px; border-top: 2px solid var(--accent); padding-top: 10px;">
                                    <span>Residual Risk:</span>
                                    <span><span class="risk-badge risk-${threat.residualRiskLevel.toLowerCase().replace(' ', '-')}">${threat.residualRiskLevel}</span></span>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderExpandedTable(container) {
            const impactColCount = config.impactCategories.length + 1; // +1 for score
            const likelihoodColCount = config.likelihoodFactors.length + 1; // +1 for score
            
            let html = '<p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">üí° Hover over column headers for explanations.</p>';
            html += '<div style="overflow-x: auto;"><table class="threats-table expanded-table"><thead>';
            
            // Category header row
            html += '<tr class="category-row">';
            html += '<th colspan="5" class="category-header category-info">Threat Information</th>';
            html += `<th colspan="${impactColCount}" class="category-header category-impact">Impact Assessment (0-4, higher = worse)</th>`;
            html += `<th colspan="${likelihoodColCount}" class="category-header category-likelihood">Likelihood Assessment (0-3, higher = easier)</th>`;
            html += '<th colspan="2" class="category-header category-risk">Risk</th>';
            html += '<th class="category-header"></th>';
            html += '</tr>';
            
            // Column header row
            html += '<tr>';
            
            // Basic info columns - sortable
            html += `<th class="tooltip-header col-id sortable ${currentSort.field === 'id' ? 'sort-' + currentSort.direction : ''}" onclick="sortBy('id')" title="Unique threat identifier">ID<span class="sort-icon"></span></th>`;
            html += `<th class="tooltip-header col-name sortable ${currentSort.field === 'name' ? 'sort-' + currentSort.direction : ''}" onclick="sortBy('name')" title="Name/title of the threat">Name<span class="sort-icon"></span></th>`;
            html += '<th class="tooltip-header col-class" title="Threat class category">Class</th>';
            html += '<th class="tooltip-header col-target" title="Target application">Target</th>';
            html += '<th class="tooltip-header col-stride border-right" title="STRIDE+O category">STRIDE</th>';
            
            // Dynamic Impact columns
            config.impactCategories.forEach((cat, idx) => {
                const isLast = idx === config.impactCategories.length - 1;
                html += `<th class="tooltip-header impact-header col-impact" title="${cat.description || cat.name}">${cat.name.substring(0, 5)}</th>`;
            });
            html += `<th class="tooltip-header impact-header col-impact border-right sortable ${currentSort.field === 'impactScore' ? 'sort-' + currentSort.direction : ''}" onclick="sortBy('impactScore')" title="Overall Impact Score">Score<span class="sort-icon"></span></th>`;
            
            // Dynamic Likelihood columns
            config.likelihoodFactors.forEach((factor, idx) => {
                html += `<th class="tooltip-header likelihood-header col-likelihood" title="${factor.description || factor.name}">${factor.name.substring(0, 5)}</th>`;
            });
            html += `<th class="tooltip-header likelihood-header col-likelihood border-right sortable ${currentSort.field === 'likelihoodScore' ? 'sort-' + currentSort.direction : ''}" onclick="sortBy('likelihoodScore')" title="Overall Likelihood Score">Score<span class="sort-icon"></span></th>`;
            
            // Risk columns - sortable
            html += `<th class="tooltip-header risk-header col-risk-main sortable ${currentSort.field === 'risk' ? 'sort-' + currentSort.direction : ''}" onclick="sortBy('risk')" title="Risk Level">Risk<span class="sort-icon"></span></th>`;
            html += `<th class="tooltip-header risk-header col-risk-resid border-right sortable ${currentSort.field === 'residual' ? 'sort-' + currentSort.direction : ''}" onclick="sortBy('residual')" title="Residual Risk">Resid<span class="sort-icon"></span></th>`;
            html += '<th class="col-actions">Actions</th>';
            
            html += '</tr></thead><tbody>';
            
            filteredThreats.forEach(threat => {
                html += `<tr>
                    <td><strong>${threat.id}</strong></td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${threat.name || ''}">${threat.name || 'Unnamed'}</td>
                    <td style="font-size: 0.75rem; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: normal;" title="${threat.threatClass || ''}">${threat.threatClass || '-'}</td>
                    <td style="font-size: 0.75rem; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: normal;" title="${threat.target || ''}">${threat.target || '-'}</td>
                    <td class="border-right" title="${getStrideFullName(threat.stride)}">${threat.stride || '-'}</td>`;
                
                // Dynamic impact cells
                config.impactCategories.forEach(cat => {
                    const value = threat.impact && threat.impact[cat.id] !== undefined ? threat.impact[cat.id] : 0;
                    html += `<td class="impact-cell impact-${value}" title="${getImpactLabel(value)}">${value}</td>`;
                });
                html += `<td class="score-cell border-right" title="${getImpactLabel(threat.impactScore)}"><span class="risk-badge risk-${getImpactClass(threat.impactScore)}">${threat.impactScore}</span></td>`;
                
                // Dynamic likelihood cells
                config.likelihoodFactors.forEach(factor => {
                    const value = threat.likelihood && threat.likelihood[factor.id] !== undefined ? threat.likelihood[factor.id] : 0;
                    html += `<td class="likelihood-cell likelihood-${value}" title="${factor.name}">${value}</td>`;
                });
                html += `<td class="score-cell border-right" title="${getLikelihoodLabel(threat.likelihoodScore)}"><span class="risk-badge risk-${getLikelihoodClass(threat.likelihoodScore)}">${threat.likelihoodScore.toFixed(1)}</span></td>`;
                
                html += `<td><span class="risk-badge risk-${threat.riskLevel.toLowerCase().replace(' ', '-')}">${threat.riskLevel}</span></td>
                    <td class="border-right"><span class="risk-badge risk-${threat.residualRiskLevel.toLowerCase().replace(' ', '-')}">${threat.residualRiskLevel}</span></td>
                    <td class="threat-actions">
                        <button class="btn btn-secondary" onclick="duplicateThreat('${threat.id}')" style="padding: 4px 8px; font-size: 0.8rem;" title="Duplicate">üìã</button>
                        <button class="btn btn-secondary" onclick="editThreat('${threat.id}')" style="padding: 4px 8px; font-size: 0.8rem;">Edit</button>
                        <button class="btn btn-danger" onclick="deleteThreat('${threat.id}')" style="padding: 4px 8px; font-size: 0.8rem;">Del</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            container.innerHTML = html;
        }

        function getLikelihoodClass(score) {
            if (score < 0.6) return 'very-low';
            if (score < 1.2) return 'low';
            if (score < 1.8) return 'medium';
            if (score < 2.4) return 'high';
            return 'critical';
        }

        function getImpactClass(score) {
            const classes = ['very-low', 'low', 'medium', 'high', 'critical'];
            return classes[score] || 'very-low';
        }

        function getImpactLabel(score) {
            // Use configurable impact level names
            const level = config.impactLevels.find(l => l.value === score);
            return level ? level.name : 'Unknown';
        }
        
        // Generate dynamic impact details HTML for a threat
        function renderImpactDetails(threat) {
            let html = '';
            config.impactCategories.forEach(cat => {
                const value = threat.impact && threat.impact[cat.id] !== undefined ? threat.impact[cat.id] : 0;
                html += `<div class="score-row"><span>${cat.name}:</span><span>${getImpactLabel(value)} (${value})</span></div>`;
            });
            return html;
        }
        
        // Generate dynamic likelihood details HTML for a threat
        function renderLikelihoodDetails(threat) {
            let html = '';
            config.likelihoodFactors.forEach(factor => {
                const value = threat.likelihood && threat.likelihood[factor.id] !== undefined ? threat.likelihood[factor.id] : 0;
                html += `<div class="score-row"><span>${factor.name}:</span><span>${value}</span></div>`;
            });
            return html;
        }

        function editThreat(id) {
            const threat = threats.find(t => t.id === id);
            if (!threat) return;
            
            editingThreatId = id;
            
            document.getElementById('threat-id').value = threat.id;
            document.getElementById('threat-name').value = threat.name || '';
            document.getElementById('threat-description').value = threat.description || '';
            document.getElementById('attack-scenario').value = threat.attackScenario || '';
            document.getElementById('threat-class').value = threat.threatClass || '';
            document.getElementById('threat-target').value = threat.target || '';
            document.getElementById('mitigations').value = threat.mitigations || '';
            
            document.querySelectorAll('.stride-item').forEach(el => {
                if (threat.stride && threat.stride.includes(el.dataset.stride)) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
            
            // Dynamically populate impact dropdowns
            config.impactCategories.forEach(cat => {
                const el = document.getElementById('impact-' + cat.id);
                if (el && threat.impact && threat.impact[cat.id] !== undefined) {
                    el.value = threat.impact[cat.id];
                }
            });
            
            // Dynamically populate likelihood dropdowns
            config.likelihoodFactors.forEach(factor => {
                const el = document.getElementById('likelihood-' + factor.id);
                if (el && threat.likelihood && threat.likelihood[factor.id] !== undefined) {
                    el.value = threat.likelihood[factor.id];
                }
            });
            
            // Dynamically populate residual likelihood dropdowns
            if (threat.residualLikelihood) {
                config.likelihoodFactors.forEach(factor => {
                    const el = document.getElementById('residual-' + factor.id);
                    if (el && threat.residualLikelihood[factor.id] !== undefined) {
                        el.value = threat.residualLikelihood[factor.id];
                    }
                });
            }
            
            calculateScores();
            calculateResidualRisk();
            showTab('add-threat');
        }

        function deleteThreat(id) {
            if (confirm('Are you sure you want to delete this threat?')) {
                threats = threats.filter(t => t.id !== id);
                saveThreatsToStorage();
                filterThreats();
                updateDashboard();
                renderThreatsOnMatrix();
            }
        }

        // Dashboard
        function updateDashboard() {
            document.getElementById('total-threats').textContent = threats.length;
            
            const counts = {
                critical: 0,
                veryHigh: 0,
                high: 0,
                medium: 0,
                low: 0,
                veryLow: 0
            };
            
            threats.forEach(threat => {
                if (threat.riskLevel === 'CRITICAL') counts.critical++;
                else if (threat.riskLevel === 'VERY HIGH') counts.veryHigh++;
                else if (threat.riskLevel === 'HIGH') counts.high++;
                else if (threat.riskLevel === 'MEDIUM') counts.medium++;
                else if (threat.riskLevel === 'LOW') counts.low++;
                else counts.veryLow++;
            });
            
            document.getElementById('critical-count').textContent = counts.critical;
            document.getElementById('high-count').textContent = counts.high + counts.veryHigh;
            document.getElementById('medium-count').textContent = counts.medium;
            document.getElementById('low-count').textContent = counts.low + counts.veryLow;
            
            // Update all charts
            updateRiskChart(counts);
            updateStrideChart();
            updateClassChart();
            
            // Update recent threats
            updateRecentThreats();
        }

        function updateRiskChart(counts) {
            const chartContainer = document.getElementById('risk-chart');
            const total = threats.length || 1;
            
            if (threats.length === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); width: 100%;">Add threats to see risk distribution</div>';
                return;
            }
            
            const maxHeight = 200;
            const riskData = [
                { label: 'Critical', count: counts.critical, color: 'var(--critical)' },
                { label: 'V.High', count: counts.veryHigh, color: 'var(--very-high)' },
                { label: 'High', count: counts.high, color: 'var(--high)' },
                { label: 'Medium', count: counts.medium, color: 'var(--medium)' },
                { label: 'Low', count: counts.low, color: 'var(--low)' },
                { label: 'V.Low', count: counts.veryLow, color: 'var(--very-low)' }
            ];
            
            const maxCount = Math.max(...riskData.map(d => d.count), 1);
            
            let html = '<div style="display: flex; align-items: flex-end; gap: 15px; width: 100%; justify-content: center; height: 100%;">';
            riskData.forEach(d => {
                const height = (d.count / maxCount) * maxHeight;
                html += `
                    <div style="text-align: center; flex: 1; max-width: 80px;">
                        <div style="height: ${height}px; background: ${d.color}; border-radius: 6px 6px 0 0; min-height: ${d.count > 0 ? 20 : 5}px; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5px; color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${d.count > 0 ? d.count : ''}</div>
                        <div style="margin-top: 8px; font-size: 0.75rem; color: var(--text-secondary);">${d.label}</div>
                    </div>
                `;
            });
            html += '</div>';
            chartContainer.innerHTML = html;
        }
        
        function updateStrideChart() {
            const chartContainer = document.getElementById('stride-chart');
            
            if (threats.length === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); width: 100%;">Add threats to see STRIDE distribution</div>';
                return;
            }
            
            const strideCounts = { S: 0, T: 0, R: 0, I: 0, D: 0, E: 0 };
            const strideLabels = { 
                S: 'Spoofing', 
                T: 'Tampering', 
                R: 'Repudiation', 
                I: 'Info Disc.', 
                D: 'DoS', 
                E: 'Elevation' 
            };
            const strideColors = {
                S: '#e91e63', T: '#9c27b0', R: '#673ab7', 
                I: '#3f51b5', D: '#2196f3', E: '#00bcd4'
            };
            
            threats.forEach(t => {
                if (t.stride) {
                    for (const c of t.stride) {
                        if (strideCounts.hasOwnProperty(c)) strideCounts[c]++;
                    }
                }
            });
            
            const maxCount = Math.max(...Object.values(strideCounts), 1);
            const maxHeight = 180;
            
            let html = '<div style="display: flex; align-items: flex-end; gap: 10px; width: 100%; justify-content: center; height: 100%;">';
            Object.keys(strideCounts).forEach(key => {
                const count = strideCounts[key];
                const height = (count / maxCount) * maxHeight;
                html += `
                    <div style="text-align: center; flex: 1;" title="${strideLabels[key]}">
                        <div style="height: ${height}px; background: ${strideColors[key]}; border-radius: 6px 6px 0 0; min-height: ${count > 0 ? 20 : 5}px; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5px; color: white; font-weight: bold;">${count > 0 ? count : ''}</div>
                        <div style="margin-top: 8px; font-size: 0.8rem; font-weight: bold; color: ${strideColors[key]};">${key}</div>
                        <div style="font-size: 0.65rem; color: var(--text-secondary);">${strideLabels[key]}</div>
                    </div>
                `;
            });
            html += '</div>';
            chartContainer.innerHTML = html;
        }
        
        function updateClassChart() {
            const chartContainer = document.getElementById('class-chart');
            
            if (threats.length === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); width: 100%;">Add threats to see threat class distribution</div>';
                return;
            }
            
            const classCounts = {};
            threats.forEach(t => {
                const cls = t.threatClass || 'Unclassified';
                classCounts[cls] = (classCounts[cls] || 0) + 1;
            });
            
            const classes = Object.keys(classCounts);
            const maxCount = Math.max(...Object.values(classCounts), 1);
            const maxHeight = 180;
            const classColors = ['#ff7043', '#42a5f5', '#66bb6a', '#ab47bc', '#ffca28', '#26c6da'];
            
            let html = '<div style="display: flex; align-items: flex-end; gap: 10px; width: 100%; justify-content: center; height: 100%;">';
            classes.forEach((cls, idx) => {
                const count = classCounts[cls];
                const height = (count / maxCount) * maxHeight;
                const color = classColors[idx % classColors.length];
                const shortName = cls.length > 15 ? cls.substring(0, 12) + '...' : cls;
                
                html += `
                    <div style="text-align: center; flex: 1; max-width: 100px;" title="${cls}">
                        <div style="height: ${height}px; background: ${color}; border-radius: 6px 6px 0 0; min-height: 25px; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5px; color: white; font-weight: bold;">${count}</div>
                        <div style="margin-top: 8px; font-size: 0.65rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${shortName}</div>
                    </div>
                `;
            });
            html += '</div>';
            chartContainer.innerHTML = html;
        }

        function updateRecentThreats() {
            const container = document.getElementById('recent-threats');
            const recent = threats.slice(-5).reverse();
            
            if (recent.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No threats added yet. Go to "Add Threat" to begin your assessment.</p>';
                return;
            }
            
            let html = '<table class="threats-table"><thead><tr><th>ID</th><th>Name</th><th>Risk Level</th></tr></thead><tbody>';
            recent.forEach(threat => {
                html += `<tr>
                    <td>${threat.id}</td>
                    <td>${threat.name || 'Unnamed'}</td>
                    <td><span class="risk-badge risk-${threat.riskLevel.toLowerCase().replace(' ', '-')}">${threat.riskLevel}</span></td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Risk matrix visualization
        function renderThreatsOnMatrix() {
            // Render interactive matrix grid
            renderInteractiveMatrix();
            
            // Render threats table
            const container = document.getElementById('threats-on-matrix');
            
            if (threats.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">Add threats to see them plotted on the risk matrix.</p>';
                return;
            }
            
            let html = '<table class="threats-table"><thead><tr><th>Threat</th><th>Impact</th><th>Likelihood</th><th>Risk</th></tr></thead><tbody>';
            
            threats.forEach(threat => {
                html += `<tr>
                    <td><strong>${threat.id}</strong>: ${threat.name || 'Unnamed'}</td>
                    <td>${getImpactLabel(threat.impactScore)}</td>
                    <td>${getLikelihoodLabel(threat.likelihoodScore)}</td>
                    <td><span class="risk-badge risk-${threat.riskLevel.toLowerCase().replace(' ', '-')}">${threat.riskLevel}</span></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function renderInteractiveMatrix() {
            const matrixGrid = document.getElementById('risk-matrix-grid');
            
            // Use configurable risk matrix
            const riskMatrix = config.riskMatrix;
            
            // Build risk colors from config
            const riskColors = {};
            config.riskLevels.forEach(level => {
                riskColors[level.name] = level.color;
            });
            
            const likelihoodLabels = ['Very Unlikely', 'Unlikely', 'Moderately Likely', 'Likely', 'Very Likely'];
            const impactLabels = config.impactLevels.map(l => l.name);
            
            // Count threats in each cell
            const cellCounts = {};
            threats.forEach(threat => {
                let likelihoodIdx = getLikelihoodIndex(threat.likelihoodScore);
                let impactIdx = threat.impactScore;
                const key = `${likelihoodIdx}-${impactIdx}`;
                if (!cellCounts[key]) cellCounts[key] = [];
                cellCounts[key].push(threat);
            });
            
            let html = '';
            
            // Header row
            html += '<div class="matrix-cell"></div>';
            impactLabels.forEach(label => {
                html += `<div class="matrix-cell matrix-header">${label}</div>`;
            });
            
            // Matrix rows (reversed so Very Likely is at top)
            for (let l = 4; l >= 0; l--) {
                html += `<div class="matrix-cell matrix-label">${likelihoodLabels[l]}</div>`;
                
                for (let i = 0; i <= 4; i++) {
                    const riskLevel = riskMatrix[l][i];
                    const color = riskColors[riskLevel];
                    const key = `${l}-${i}`;
                    const threatsInCell = cellCounts[key] || [];
                    const count = threatsInCell.length;
                    
                    const hasThreats = count > 0;
                    const dataAttr = hasThreats ? `data-count="${count}" data-key="${key}"` : '';
                    const clickHandler = hasThreats ? `onclick="showMatrixTooltip('${key}')"` : '';
                    const hasThreatsClass = hasThreats ? 'has-threats' : '';
                    
                    html += `<div class="matrix-cell ${hasThreatsClass}" style="background: ${color};" ${dataAttr} ${clickHandler}>
                        ${riskLevel.replace(' ', '<br>')}
                    </div>`;
                }
            }
            
            matrixGrid.innerHTML = html;
        }
        
        function getLikelihoodIndex(score) {
            if (score < 0.6) return 0;
            if (score < 1.2) return 1;
            if (score < 1.8) return 2;
            if (score < 2.4) return 3;
            return 4;
        }
        
        function showMatrixTooltip(key) {
            const [likelihoodIdx, impactIdx] = key.split('-').map(Number);
            
            const threatsInCell = threats.filter(t => {
                return getLikelihoodIndex(t.likelihoodScore) === likelihoodIdx && t.impactScore === impactIdx;
            });
            
            const tooltip = document.getElementById('matrix-tooltip');
            const content = document.getElementById('matrix-tooltip-content');
            
            if (threatsInCell.length === 0) {
                tooltip.style.display = 'none';
                return;
            }
            
            let html = '<ul style="margin: 0; padding-left: 20px;">';
            threatsInCell.forEach(t => {
                html += `<li style="margin-bottom: 5px;">
                    <strong>${t.id}</strong>: ${t.name || 'Unnamed'} 
                    <span class="risk-badge risk-${t.riskLevel.toLowerCase().replace(' ', '-')}" style="margin-left: 10px;">${t.riskLevel}</span>
                </li>`;
            });
            html += '</ul>';
            
            content.innerHTML = html;
            tooltip.style.display = 'block';
        }

        function getLikelihoodLabel(score) {
            if (score < 0.6) return 'Very Unlikely';
            if (score < 1.2) return 'Unlikely';
            if (score < 1.8) return 'Moderately Likely';
            if (score < 2.4) return 'Likely';
            return 'Very Likely';
        }

        // Export functions
        function exportCSV() {
            if (threats.length === 0) {
                showToast('No threats to export.', 'warning');
                return;
            }
            
            // Build dynamic headers
            const headers = ['Threat ID', 'Threat Name', 'Description', 'Attack Scenario', 'Threat Class', 'Target', 'STRIDE Category'];
            
            // Add dynamic impact category headers
            config.impactCategories.forEach(cat => {
                headers.push(`Impact ${cat.name}`);
            });
            headers.push('Impact Score', 'Impact Category');
            
            // Add dynamic likelihood factor headers
            config.likelihoodFactors.forEach(factor => {
                headers.push(factor.name);
            });
            headers.push('Likelihood Score', 'Likelihood Category', 'Risk Level', 'Mitigations', 'Residual Likelihood Score', 'Residual Risk Level');
            
            let csv = headers.join(',') + '\n';
            
            threats.forEach(threat => {
                const row = [
                    threat.id,
                    `"${(threat.name || '').replace(/"/g, '""')}"`,
                    `"${(threat.description || '').replace(/"/g, '""')}"`,
                    `"${(threat.attackScenario || '').replace(/"/g, '""')}"`,
                    `"${(threat.threatClass || '').replace(/"/g, '""')}"`,
                    `"${(threat.target || '').replace(/"/g, '""')}"`,
                    threat.stride || ''
                ];
                
                // Add dynamic impact values
                config.impactCategories.forEach(cat => {
                    row.push(threat.impact && threat.impact[cat.id] !== undefined ? threat.impact[cat.id] : 0);
                });
                row.push(threat.impactScore, getImpactLabel(threat.impactScore));
                
                // Add dynamic likelihood values
                config.likelihoodFactors.forEach(factor => {
                    row.push(threat.likelihood && threat.likelihood[factor.id] !== undefined ? threat.likelihood[factor.id] : 0);
                });
                row.push(
                    threat.likelihoodScore.toFixed(2),
                    getLikelihoodLabel(threat.likelihoodScore),
                    threat.riskLevel,
                    `"${(threat.mitigations || '').replace(/"/g, '""')}"`,
                    threat.residualLikelihoodScore.toFixed(2),
                    threat.residualRiskLevel
                );
                
                csv += row.join(',') + '\n';
            });
            
            downloadFile(csv, 'tara-assessment.csv', 'text/csv');
        }

        function exportJSON() {
            if (threats.length === 0) {
                showToast('No threats to export.', 'warning');
                return;
            }
            
            const data = {
                exportDate: new Date().toISOString(),
                framework: 'TARA - Threat Analysis & Risk Assessment',
                config: config,  // Include config so imports have matching categories
                threats: threats
            };
            
            downloadFile(JSON.stringify(data, null, 2), 'tara-assessment.json', 'application/json');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importJSON() {
            document.getElementById('json-file-input').click();
        }

        function importCSV() {
            document.getElementById('csv-file-input').click();
        }

        function handleJSONImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.threats && Array.isArray(data.threats)) {
                        // If config is included, import it as well
                        if (data.config) {
                            Object.keys(data.config).forEach(key => {
                                config[key] = data.config[key];
                                saveConfig(key, config[key]);
                            });
                            applyCustomRiskColors();
                        }
                        
                        threats = data.threats;
                        saveThreatsToStorage();
                        updateTargetFilter();
                        updateAddThreatForm();
                        showToast(`Imported ${threats.length} threats successfully!`, 'success');
                        updateDashboard();
                        filterThreats();
                    } else {
                        showToast('Invalid file format. Please import a valid TARA JSON file.', 'error');
                    }
                } catch (err) {
                    showToast('Error parsing file: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset for re-import
        }

        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = parseCSVLine(lines[0]);
                    
                    // Build column index mapping from headers
                    const headerMap = {};
                    headers.forEach((h, idx) => {
                        headerMap[h.toLowerCase().trim()] = idx;
                    });
                    
                    const importedThreats = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        
                        const values = parseCSVLine(lines[i]);
                        if (values.length < 7) continue;
                        
                        // Build impact object dynamically
                        const impact = {};
                        config.impactCategories.forEach(cat => {
                            const headerKey = `impact ${cat.name}`.toLowerCase();
                            const idx = headerMap[headerKey];
                            impact[cat.id] = idx !== undefined ? parseInt(values[idx]) || 0 : 0;
                        });
                        
                        // Build likelihood object dynamically
                        const likelihood = {};
                        config.likelihoodFactors.forEach(factor => {
                            const headerKey = factor.name.toLowerCase();
                            const idx = headerMap[headerKey];
                            likelihood[factor.id] = idx !== undefined ? parseInt(values[idx]) || 0 : 0;
                        });
                        
                        // Build residual likelihood with default values
                        const residualLikelihood = {};
                        config.likelihoodFactors.forEach(factor => {
                            residualLikelihood[factor.id] = 1;
                        });
                        
                        // Map CSV columns to threat object
                        const threat = {
                            id: values[headerMap['threat id']] || 'T' + (importedThreats.length + 1),
                            name: values[headerMap['threat name']] || '',
                            description: values[headerMap['description']] || '',
                            attackScenario: values[headerMap['attack scenario']] || '',
                            threatClass: values[headerMap['threat class']] || '',
                            target: values[headerMap['target']] || '',
                            stride: values[headerMap['stride category']] || '',
                            impact: impact,
                            likelihood: likelihood,
                            mitigations: values[headerMap['mitigations']] || '',
                            residualLikelihood: residualLikelihood,
                            createdAt: new Date().toISOString()
                        };
                        
                        // Calculate scores using configured methods
                        const impactValues = Object.values(threat.impact);
                        if (config.impactCalculation === 'average') {
                            threat.impactScore = impactValues.length > 0 ? impactValues.reduce((a, b) => a + b, 0) / impactValues.length : 0;
                        } else {
                            threat.impactScore = Math.max(...impactValues, 0);
                        }
                        
                        const likelihoodValues = Object.values(threat.likelihood);
                        if (config.likelihoodCalculation === 'max') {
                            threat.likelihoodScore = Math.max(...likelihoodValues, 0);
                        } else {
                            threat.likelihoodScore = likelihoodValues.length > 0 ? likelihoodValues.reduce((a, b) => a + b, 0) / likelihoodValues.length : 0;
                        }
                        
                        threat.riskLevel = calculateRiskLevel(threat.impactScore, threat.likelihoodScore);
                        
                        const residualValues = Object.values(threat.residualLikelihood);
                        if (config.likelihoodCalculation === 'max') {
                            threat.residualLikelihoodScore = Math.max(...residualValues, 0);
                        } else {
                            threat.residualLikelihoodScore = residualValues.length > 0 ? residualValues.reduce((a, b) => a + b, 0) / residualValues.length : 0;
                        }
                        threat.residualRiskLevel = calculateRiskLevel(threat.impactScore, threat.residualLikelihoodScore);
                        
                        importedThreats.push(threat);
                    }
                    
                    if (importedThreats.length > 0) {
                        threats = importedThreats;
                        saveThreatsToStorage();
                        updateTargetFilter();
                        showToast(`Imported ${threats.length} threats from CSV successfully!`, 'success');
                        updateDashboard();
                        filterThreats();
                    } else {
                        showToast('No valid threats found in CSV file.', 'error');
                    }
                } catch (err) {
                    showToast('Error parsing CSV: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset for re-import
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }

        // Load all 14 threats from Table 2 in the paper
        function loadAllPaperThreats() {
            if (threats.length > 0) {
                if (!confirm('This will replace existing threats with all 14 threats from Table 2. Continue?')) return;
            }
            
            threats = [
                // Class I: Short-term Context Poisoning
                {
                    id: 'T1',
                    name: 'Toxic Content Generation',
                    description: 'Attacker causes the assistant to generate offensive content via indirect prompt injection in calendar invitation. The poisoned prompt instructs Gemini to output offensive/harmful messages to the user.',
                    attackScenario: 'Indirect Prompt Injection (Google Doc) ‚Üí Short-term Context Poisoning ‚Üí Toxic content output to Google Assistant',
                    stride: 'T',
                    impact: { safety: 2, privacy: 0, financial: 0, operational: 0 },
                    impactScore: 2,
                    likelihood: { equipment: 3, expertise: 2, wop: 3, knowledge: 2, time: 3, interaction: 2 },
                    likelihoodScore: 2.5,
                    riskLevel: 'HIGH',
                    mitigations: 'I/O Validation: Deploy classifiers to detect offensive content in agent outputs using predefined dictionaries',
                    residualLikelihood: { equipment: 1, expertise: 1, wop: 3, knowledge: 0, time: 0, interaction: 2 },
                    residualLikelihoodScore: 1.17,
                    residualRiskLevel: 'LOW',
                    target: 'Google Assistant',
                    threatClass: 'Short-term Context Poisoning',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'T2',
                    name: 'Spamming',
                    description: 'Attacker uses prompt injection to make assistant spam user with promotional content or propaganda. Demonstrated with Kickstarter project recommendations.',
                    attackScenario: 'Indirect Prompt Injection (Google Doc) ‚Üí Short-term Context Poisoning ‚Üí Spam output to Gemini for Mobile',
                    stride: 'T',
                    impact: { safety: 1, privacy: 0, financial: 0, operational: 0 },
                    impactScore: 1,
                    likelihood: { equipment: 3, expertise: 2, wop: 3, knowledge: 2, time: 3, interaction: 2 },
                    likelihoodScore: 2.5,
                    riskLevel: 'MEDIUM',
                    mitigations: 'I/O Validation: Detect promotional/spam content patterns in outputs',
                    residualLikelihood: { equipment: 1, expertise: 1, wop: 3, knowledge: 0, time: 0, interaction: 2 },
                    residualLikelihoodScore: 1.17,
                    residualRiskLevel: 'VERY LOW',
                    target: 'Gemini for Mobile',
                    threatClass: 'Short-term Context Poisoning',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'T3',
                    name: 'Phishing',
                    description: 'Attacker uses prompt injection to display phishing links through the trusted assistant interface. Users may trust links presented by the assistant more than regular phishing attempts.',
                    attackScenario: 'Indirect Prompt Injection (Google Doc) ‚Üí Short-term Context Poisoning ‚Üí Phishing link display via Google Assistant',
                    stride: 'SI',
                    impact: { safety: 0, privacy: 4, financial: 2, operational: 0 },
                    impactScore: 4,
                    likelihood: { equipment: 3, expertise: 2, wop: 3, knowledge: 2, time: 3, interaction: 0 },
                    likelihoodScore: 2.17,
                    riskLevel: 'VERY HIGH',
                    mitigations: 'URL sanitization and suspicious URL redaction; markdown sanitization',
                    residualLikelihood: { equipment: 1, expertise: 1, wop: 3, knowledge: 0, time: 0, interaction: 0 },
                    residualLikelihoodScore: 0.83,
                    residualRiskLevel: 'MEDIUM',
                    target: 'Google Assistant',
                    threatClass: 'Short-term Context Poisoning',
                    createdAt: new Date().toISOString()
                },
                // Class II: Long-term Memory Poisoning
                {
                    id: 'T4',
                    name: 'Disinformation',
                    description: 'Permanent memory poisoning that affects Gemini\'s long-term memory ("Saved Info"), enabling persistent malicious activity across independent sessions. Attacker introduces memory items with false information.',
                    attackScenario: 'Indirect Prompt Injection (Google Doc) ‚Üí Permanent Memory Poisoning ‚Üí Disinformation persists in Gemini for Web',
                    stride: 'T',
                    impact: { safety: 0, privacy: 0, financial: 0, operational: 0 },
                    impactScore: 0,
                    likelihood: { equipment: 3, expertise: 2, wop: 3, knowledge: 2, time: 3, interaction: 2 },
                    likelihoodScore: 2.5,
                    riskLevel: 'LOW',
                    mitigations: 'User confirmation before updating saved info when external data is in context; chaining prevention mechanisms',
                    residualLikelihood: { equipment: 1, expertise: 1, wop: 3, knowledge: 0, time: 0, interaction: 2 },
                    residualLikelihoodScore: 1.17,
                    residualRiskLevel: 'VERY LOW',
                    target: 'Gemini for Web',
                    threatClass: 'Long-term Memory Poisoning',
                    createdAt: new Date().toISOString()
                },
                // Class III: Tool Misuse
                {
                    id: 'T5',
                    name: 'Deleting/Adding Events in Calendar',
                    description: 'Exploitation of Google Calendar Agent tools to delete or add events without user consent. The compromised agent misuses its own tools to manipulate user\'s schedule.',
                    attackScenario: 'Indirect Prompt Injection (Google Calendar) ‚Üí Context/Memory Poisoning ‚Üí Automatic Agent Invocation (Google Calendar) ‚Üí Delete/Add events',
                    stride: 'TE',
                    impact: { safety: 0, privacy: 0, financial: 0, operational: 1 },
                    impactScore: 1,
                    likelihood: { equipment: 3, expertise: 2, wop: 3, knowledge: 2, time: 3, interaction: 2 },
                    likelihoodScore: 2.5,
                    riskLevel: 'MEDIUM',
                    mitigations: 'Chaining prevention mechanisms to prevent agent/tool chaining; single planning step per inference',
                    residualLikelihood: { equipment: 1, expertise: 1, wop: 3, knowledge: 0, time: 0, interaction: 2 },
                    residualLikelihoodScore: 1.17,
                    residualRiskLevel: 'VERY LOW',
                    target: 'Gemini for Web',
                    threatClass: 'Tool Misuse',
                    createdAt: new Date().toISOString()
                },
                // Class IV: Automatic Agent Invocation
                {
                    id: 'T6',
                    name: 'Opening Windows in User\'s Apartment',
                    description: 'Attacker uses prompt injection to trigger Google Home Agent to open windows in victim\'s home. This demonstrates physical-world impact through automatic agent invocation.',
                    attackScenario: 'Indirect Prompt Injection (Google Calendar) ‚Üí Short-term Context Poisoning ‚Üí Automatic Agent Invocation (Google Home) ‚Üí Open windows',
                    stride: 'TE',
                    impact: { safety: 3, privacy: 4, financial: 0, operational: 1 },
                    impactScore: 4,
                    likelihood: { equipment: 3, expertise: 2, wop: 3, knowledge: 2, time: 3, interaction: 2 },
                    likelihoodScore: 2.5,
                    riskLevel: 'CRITICAL',
                    mitigations: 'User Confirmation for sensitive home actions; Context Isolation between agents; Chaining Prevention; I/O Validation',
                    residualLikelihood: { equipment: 1, expertise: 1, wop: 3, knowledge: 0, time: 0, interaction: 2 },
                    residualLikelihoodScore: 1.17,
                    residualRiskLevel: 'MEDIUM',
                    target: 'Gemini for Mobile',
                    threatClass: 'Automatic Agent Invocation',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'T7',
                    name: 'Activating Boiler in User\'s Apartment',
                    description: 'Attacker uses prompt injection to trigger Google Home Agent to activate the boiler in victim\'s home. Could go undetected if user is away.',
                    attackScenario: 'Indirect Prompt Injection (Google Calendar) ‚Üí Short-term Context Poisoning ‚Üí Automatic Agent Invocation (Google Home) ‚Üí Activate boiler',
                    stride: 'TE',
                    impact: { safety: 2, privacy: 0, financial: 1, operational: 1 },
                    impactScore: 2,
                    likelihood: { equipment: 3, expertise: 2, wop: 3, knowledge: 2, time: 3, interaction: 2 },
                    likelihoodScore: 2.5,
                    riskLevel: 'HIGH',
                    mitigations: 'User Confirmation for home automation actions; Context Isolation; Chaining Prevention; I/O Validation',
                    residualLikelihood: { equipment: 1, expertise: 1, wop: 3, knowledge: 0, time: 0, interaction: 2 },
                    residualLikelihoodScore: 1.17,
                    residualRiskLevel: 'LOW',
                    target: 'Gemini for Mobile',
                    threatClass: 'Automatic Agent Invocation',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'T8',
                    name: 'Turning Lights On/Off in User\'s Apartment',
                    description: 'Attacker uses prompt injection to trigger Google Home Agent to control lights in victim\'s home.',
                    attackScenario: 'Indirect Prompt Injection (Google Calendar) ‚Üí Short-term Context Poisoning ‚Üí Automatic Agent Invocation (Google Home) ‚Üí Control lights',
                    stride: 'TE',
                    impact: { safety: 2, privacy: 0, financial: 1, operational: 1 },
                    impactScore: 2,
                    likelihood: { equipment: 3, expertise: 2, wop: 3, knowledge: 2, time: 3, interaction: 2 },
                    likelihoodScore: 2.5,
                    riskLevel: 'HIGH',
                    mitigations: 'User Confirmation for home automation actions; Context Isolation; Chaining Prevention; I/O Validation',
                    residualLikelihood: { equipment: 1, expertise: 1, wop: 3, knowledge: 0, time: 0, interaction: 2 },
                    residualLikelihoodScore: 1.17,
                    residualRiskLevel: 'LOW',
                    target: 'Gemini for Mobile',
                    threatClass: 'Automatic Agent Invocation',
                    createdAt: new Date().toISOString()
                },
                // Class V: Automatic App Invocation
                {
                    id: 'T9',
                    name: 'Downloading a File to User\'s Smartphone',
                    description: 'Attacker triggers automatic app invocation to download a file to the victim\'s smartphone via the web browser.',
                    attackScenario: 'Indirect Prompt Injection (Google Calendar) ‚Üí Context/Memory Poisoning ‚Üí Automatic Agent Invocation (Utilities) ‚Üí Automatic App Invocation (Web browser) ‚Üí Download file',
                    stride: 'TE',
                    impact: { safety: 2, privacy: 0, financial: 0, operational: 1 },
                    impactScore: 2,
                    likelihood: { equipment: 3, expertise: 2, wop: 3, knowledge: 2, time: 3, interaction: 2 },
                    likelihoodScore: 2.5,
                    riskLevel: 'MEDIUM',
                    mitigations: 'User Confirmation before launching apps; Context Isolation; Chaining Prevention; I/O Validation',
                    residualLikelihood: { equipment: 1, expertise: 1, wop: 3, knowledge: 0, time: 0, interaction: 2 },
                    residualLikelihoodScore: 1.17,
                    residualRiskLevel: 'VERY LOW',
                    target: 'Gemini for Mobile',
                    threatClass: 'Automatic App Invocation',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'T10',
                    name: 'Geolocating a User',
                    description: 'Attacker triggers HTTP request via browser to geolocate the victim based on their IP address.',
                    attackScenario: 'Indirect Prompt Injection (Google Calendar) ‚Üí Context/Memory Poisoning ‚Üí Automatic Agent Invocation (Utilities) ‚Üí Automatic App Invocation (Web browser) ‚Üí HTTP request reveals location',
                    stride: 'I',
                    impact: { safety: 2, privacy: 2, financial: 0, operational: 1 },
                    impactScore: 2,
                    likelihood: { equipment: 3, expertise: 2, wop: 3, knowledge: 2, time: 3, interaction: 2 },
                    likelihoodScore: 2.5,
                    riskLevel: 'HIGH',
                    mitigations: 'User Confirmation; Context Isolation; Chaining Prevention; URL sanitization',
                    residualLikelihood: { equipment: 1, expertise: 1, wop: 3, knowledge: 0, time: 0, interaction: 2 },
                    residualLikelihoodScore: 1.17,
                    residualRiskLevel: 'LOW',
                    target: 'Google Assistant',
                    threatClass: 'Automatic App Invocation',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'T11',
                    name: 'Video Streaming a User via Zoom',
                    description: 'Attacker uses prompt injection to launch Zoom and video stream the victim without consent. Demonstrated via both Calendar and Gmail injection vectors.',
                    attackScenario: 'Indirect Prompt Injection (Google Calendar/Gmail) ‚Üí Context/Memory Poisoning ‚Üí Automatic Agent Invocation (Utilities) ‚Üí Automatic App Invocation (Zoom) ‚Üí Video streaming',
                    stride: 'IE',
                    impact: { safety: 0, privacy: 4, financial: 0, operational: 1 },
                    impactScore: 4,
                    likelihood: { equipment: 3, expertise: 2, wop: 3, knowledge: 2, time: 3, interaction: 2 },
                    likelihoodScore: 2.5,
                    riskLevel: 'CRITICAL',
                    mitigations: 'User Confirmation before launching apps; Context Isolation; Chaining Prevention; I/O Validation for detecting app invocation attempts',
                    residualLikelihood: { equipment: 1, expertise: 1, wop: 3, knowledge: 0, time: 0, interaction: 2 },
                    residualLikelihoodScore: 1.17,
                    residualRiskLevel: 'MEDIUM',
                    target: 'Gemini for Mobile / Google Assistant',
                    threatClass: 'Automatic App Invocation',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'T12',
                    name: 'Exfiltration of User\'s Meetings',
                    description: 'Attacker exfiltrates user meeting information via browser by injecting prompt that triggers HTTP request with calendar data to attacker-controlled server.',
                    attackScenario: 'Indirect Prompt Injection (Google Calendar) ‚Üí Context/Memory Poisoning ‚Üí Automatic Agent Invocation (Utilities) ‚Üí Automatic App Invocation (Web browser) ‚Üí Meeting data exfiltrated',
                    stride: 'I',
                    impact: { safety: 0, privacy: 3, financial: 0, operational: 0 },
                    impactScore: 3,
                    likelihood: { equipment: 3, expertise: 2, wop: 3, knowledge: 2, time: 3, interaction: 2 },
                    likelihoodScore: 2.5,
                    riskLevel: 'VERY HIGH',
                    mitigations: 'User Confirmation; Context Isolation; Chaining Prevention; URL sanitization',
                    residualLikelihood: { equipment: 1, expertise: 1, wop: 3, knowledge: 0, time: 0, interaction: 2 },
                    residualLikelihoodScore: 1.17,
                    residualRiskLevel: 'LOW',
                    target: 'Gemini for Mobile',
                    threatClass: 'Automatic App Invocation',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'T13',
                    name: 'Exfiltration of User\'s Emails',
                    description: 'Attacker exfiltrates user emails via browser by injecting prompt that triggers HTTP request with email data to attacker-controlled server.',
                    attackScenario: 'Indirect Prompt Injection (Gmail) ‚Üí Context/Memory Poisoning ‚Üí Automatic Agent Invocation (Utilities) ‚Üí Automatic App Invocation (Web browser) ‚Üí Email data exfiltrated',
                    stride: 'I',
                    impact: { safety: 0, privacy: 4, financial: 0, operational: 0 },
                    impactScore: 4,
                    likelihood: { equipment: 3, expertise: 2, wop: 3, knowledge: 2, time: 3, interaction: 2 },
                    likelihoodScore: 2.5,
                    riskLevel: 'CRITICAL',
                    mitigations: 'User Confirmation; Context Isolation; Chaining Prevention; URL sanitization',
                    residualLikelihood: { equipment: 1, expertise: 1, wop: 3, knowledge: 0, time: 0, interaction: 2 },
                    residualLikelihoodScore: 1.17,
                    residualRiskLevel: 'MEDIUM',
                    target: 'Gemini for Mobile',
                    threatClass: 'Automatic App Invocation',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'T14',
                    name: 'Computer Worm',
                    description: 'Self-propagating worm that extracts user contacts and email data, exfiltrates to attacker server, and sends infected emails to extracted contacts to spread. Demonstrates lateral movement capabilities.',
                    attackScenario: 'Indirect Prompt Injection (Gmail) ‚Üí Context/Memory Poisoning ‚Üí Automatic Agent Invocation (Utilities) ‚Üí Automatic App Invocation (Web browser) ‚Üí Extract contacts ‚Üí Exfiltrate data ‚Üí Send infected emails ‚Üí Propagate',
                    stride: 'TIE',
                    impact: { safety: 0, privacy: 4, financial: 0, operational: 0 },
                    impactScore: 4,
                    likelihood: { equipment: 3, expertise: 2, wop: 3, knowledge: 2, time: 3, interaction: 2 },
                    likelihoodScore: 2.5,
                    riskLevel: 'CRITICAL',
                    mitigations: 'All mitigations combined: I/O Validation, User Confirmation, Context Isolation, Chaining Prevention',
                    residualLikelihood: { equipment: 1, expertise: 1, wop: 3, knowledge: 0, time: 0, interaction: 2 },
                    residualLikelihoodScore: 1.17,
                    residualRiskLevel: 'MEDIUM',
                    target: 'Gemini for Mobile',
                    threatClass: 'Automatic App Invocation',
                    createdAt: new Date().toISOString()
                }
            ];
            
            saveThreatsToStorage();
            updateTargetFilter();
            alert('Loaded all 14 threats from Table 2 of the paper!');
            updateDashboard();
            
            // Switch to threats list to show the loaded data
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('threats-list').classList.add('active');
            document.querySelectorAll('.tab-btn')[2].classList.add('active');
            filterThreats();
        }
        
        // Keep old function name as alias for backwards compatibility
        function loadSampleData() {
            loadAllPaperThreats();
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        // Delete all threats functionality
        function deleteAllThreats() {
            if (threats.length === 0) {
                alert('No threats to delete.');
                return;
            }
            
            document.getElementById('delete-count').textContent = threats.length;
            document.getElementById('delete-confirm-input').value = '';
            document.getElementById('confirm-delete-btn').disabled = true;
            document.getElementById('delete-confirm-modal').classList.add('active');
            document.getElementById('delete-confirm-input').focus();
        }

        function closeDeleteModal() {
            document.getElementById('delete-confirm-modal').classList.remove('active');
        }

        function confirmDeleteAll() {
            threats = [];
            saveThreatsToStorage();
            closeDeleteModal();
            updateDashboard();
            filterThreats();
            renderThreatsOnMatrix();
            alert('All threats have been deleted.');
        }

        // Listen for input to enable/disable delete button
        document.addEventListener('DOMContentLoaded', function() {
            const deleteInput = document.getElementById('delete-confirm-input');
            if (deleteInput) {
                deleteInput.addEventListener('input', function() {
                    const btn = document.getElementById('confirm-delete-btn');
                    btn.disabled = this.value !== 'DELETE';
                });
                
                deleteInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && this.value === 'DELETE') {
                        confirmDeleteAll();
                    }
                });
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            calculateScores();
            calculateResidualRisk();
            updateDashboard();
        });
    </script>
</body>
</html>
